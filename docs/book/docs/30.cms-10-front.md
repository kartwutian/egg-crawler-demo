
        <h2 id="t01. &#x521D;&#x59CB;&#x5316;&#x9879;&#x76EE;">1. &#x521D;&#x59CB;&#x5316;&#x9879;&#x76EE; <a href="#t01. &#x521D;&#x59CB;&#x5316;&#x9879;&#x76EE;"> # </a></h2>
<pre><code class="lang-js">$ npm install dva-cli -g
$ dva -v
dva-cli version 0.9.1
$ dva new cms201807
$ cd cms201807
$ cnpm i styled-components -S
$ npm start
</code></pre>
<h2 id="t12. &#x914D;&#x7F6E;&#x4EE3;&#x7406;">2. &#x914D;&#x7F6E;&#x4EE3;&#x7406; <a href="#t12. &#x914D;&#x7F6E;&#x4EE3;&#x7406;"> # </a></h2>
<p>.webpackrc.js</p>
<pre><code class="lang-js">const {resolve}=require(&apos;path&apos;);
export default {
    &quot;alias&quot;:{
        &quot;@&quot;:resolve(&quot;src&quot;)
    }
}
</code></pre>
<h2 id="t23. &#x6CE8;&#x518C;&#x767B;&#x5F55;">3. &#x6CE8;&#x518C;&#x767B;&#x5F55; <a href="#t23. &#x6CE8;&#x518C;&#x767B;&#x5F55;"> # </a></h2>
<h3 id="t33.1 login/index.js">3.1 login/index.js <a href="#t33.1 login/index.js"> # </a></h3>
<pre><code class="lang-js">import React,{Component,Fragment} from &apos;react&apos;;
import {Layout,Form,Icon,Input,Button,Checkbox,Cascader,Select,Row,Col,AutoComplete,message} from &apos;antd&apos;;
import styled from &apos;styled-components&apos;;
import { connect } from &apos;dva&apos;;
const {Footer,Content}=Layout;
const Option=Select.Option;
const AutoCompleteOption = AutoComplete.Option;
const FormItem=Form.Item;
class Login extends Component{
    handleSubmit=event =&gt; {
        event.preventDefault();
        this.userForm.props.form.validateFields((err,values) =&gt; {
                if (err) {
                    message.error(&apos;&#x8F93;&#x5165;&#x4E0D;&#x5408;&#x6CD5;!&apos;);
                } else {
                    this.props.dispatch({
                        type: this.props.isLogin?&apos;login/login&apos;:&apos;login/signup&apos;,
                        payload:values
                    });
                }
        });
    }
    changeLoginStatus=() =&gt; {
        this.props.dispatch({
            type:&apos;login/changeLoginStatus&apos;
        });
    }
    render() {
        return (
            <layout>
                <content>
                    <wrappedloginform islogin="{this.props.isLogin}" handlesubmit="{this.handleSubmit}" wrappedcomponentref="{inst" ==""> this.userForm=inst}
                        changeLoginStatus={this.changeLoginStatus}
                        errorInfo={this.props.errorInfo}
                    /&gt;
                </wrappedloginform></content>
                <footer style="{{" textalign:="" 'center'="" }}=""> &#x73E0;&#x5CF0;&#x57F9;&#x8BAD; &#xA9;2018</footer>
            </layout>
       )
   }
}

export default connect(
    state =&gt; ({
        ...state.login,
        loading:state.loading.models.login
    })
)(Login);

class LoginForm extends Component{
    state={autoCompleteResult:[],confirmDirty:false}
    handleWebsiteChange=(value) =&gt; {
        let autoCompleteResult;
        if (value) {
            autoCompleteResult=[&apos;.com&apos;,&apos;.cn&apos;,&apos;.org&apos;].map(domain=&gt;`${value}${domain}`);
        } else {
            autoCompleteResult=[];
        }
        this.setState({autoCompleteResult});
    }
    handleConfirmBlur = (e) =&gt; {
        const value = e.target.value;
        this.setState({ confirmDirty: this.state.confirmDirty || !!value });
      }

    compareToFirstPassword=(rule,value,callback) =&gt; {
        const form=this.props.form;
        if (value &amp;&amp; value !== form.getFieldValue(&apos;password&apos;)) {
            callback(&apos;&#x5BC6;&#x7801;&#x4E0D;&#x5339;&#x914D;&apos;);
        } else {
            callback();
        }
    }
    validateToNextPassword=(rule,value,callback) =&gt; {
        const form=this.props.form;
        if (value&amp;&amp;this.state.confirmDirty) {
            form.validateFields([&apos;confirm&apos;],{force:true});
        }
        callback();
    }
    render() {
        const {form: {getFieldDecorator},isLogin,handleSubmit}=this.props;
        const formItemLayout={
            labelCol:{
                span:4
            },
            wrapperCol: {
                span:20
            }

        }
        const tailFormItemLayout={
            wrapperCol: {
                span: 20,
                offset:4
            }
        }
        const addresses=[
            {
                value:&apos;guangdong&apos;,
                label: &apos;&#x5E7F;&#x4E1C;&apos;,
                children: [
                    {
                        value:&apos;guangzhou&apos;,
                        label: &apos;&#x5E7F;&#x5DDE;&apos;,
                    },
                    {
                        value:&apos;dongguan&apos;,
                        label: &apos;&#x4E1C;&#x839E;&apos;,
                    }
                ]
            },
            {
                value:&apos;shandong&apos;,
                label: &apos;&#x5C71;&#x4E1C;&apos;,
                children: [
                    {
                        value:&apos;jinan&apos;,
                        label: &apos;&#x6D4E;&#x5357;&apos;,
                    },
                    {
                        value:&apos;shouguang&apos;,
                        label: &apos;&#x5BFF;&#x5149;&apos;,
                    }
                ]
            }
        ]
        const countrySelector=getFieldDecorator(&apos;prefix&apos;,{initialValue: &apos;86&apos;})(
            <select style="{{width:" 70}}="">
                <option value="86">+86</option>
                <option value="87">+87</option>
            </select>
        );
        const websiteOptions=this.state.autoCompleteResult.map(website =&gt; (
            <autocompleteoption key="{website}">{website}</autocompleteoption>
        ));
        return (
            <formwrapper>
              <form onsubmit="{handleSubmit}" style="{{width:isLogin?&apos;300px&apos;:&apos;500px&apos;}}">
                <h3>&#x6B22;&#x8FCE;&#x6CE8;&#x518C;</h3>
                <formitem label="&#x7528;&#x6237;&#x540D;" {...formitemlayout}="">
                            {
                                getFieldDecorator(&apos;username&apos;,{
                                    rules:[{required:true,message:&apos;&#x8BF7;&#x8F93;&#x5165;&#x4F60;&#x7684;&#x7528;&#x6237;&#x540D;&apos;}]
                                })(<input prefix="{&lt;Icon" type="user" style="{{color:&apos;rbga(0,0,0,.25)&apos;}}/">} placeholder=&quot;&#x7528;&#x6237;&#x540D;&quot;/&gt;)
                            }
                </formitem>
                <formitem label="&#x5BC6;&#x7801;" {...formitemlayout}="">
                            {
                                getFieldDecorator(&apos;password&apos;,{
                            rules: [{required: true,message: &apos;&#x8BF7;&#x8F93;&#x5165;&#x4F60;&#x7684;&#x5BC6;&#x7801;&apos;},
                                {validator:this.validateToNextPassword}
                                ]
                                })(<input prefix="{&lt;Icon" type="lock" style="{{color:&apos;rbga(0,0,0,.25)&apos;}}/">} placeholder=&quot;&#x5BC6;&#x7801;&quot;/&gt;)
                            }
                    </formitem>
                {
                        !isLogin&amp;&amp;(
                            <formitem label="&#x786E;&#x8BA4;&#x5BC6;&#x7801;" {...formitemlayout}="">
                            {
                                getFieldDecorator(&apos;confirm&apos;,{
                            rules: [{required: true,message: &apos;&#x8BF7;&#x8F93;&#x5165;&#x4F60;&#x7684;&#x786E;&#x8BA4;&#x5BC6;&#x7801;&apos;},
                                {validator:this.compareToFirstPassword}
                                ]
                                })(<input prefix="{&lt;Icon" type="lock" style="{{color:&apos;rbga(0,0,0,.25)&apos;}}/">} placeholder=&quot;&#x786E;&#x8BA4;&#x5BC6;&#x7801;&quot;/&gt;)
                            }
                          </formitem>
                        )
                }
                {
                        !isLogin&amp;&amp;(
                            <formitem label="&#x90AE;&#x7BB1;" {...formitemlayout}="">
                            {
                                getFieldDecorator(&apos;email&apos;,{
                            rules: [{type:&apos;email&apos;,message:&apos;&#x5FC5;&#x987B;&#x8F93;&#x5165;&#x5408;&#x6CD5;&#x7684;&#x90AE;&#x7BB1;&#x5730;&#x5740;&apos;},{required:true,message:&apos;&#x8BF7;&#x8F93;&#x5165;&#x90AE;&#x7BB1;&apos;}]
                                })(<input prefix="{&lt;Icon" type="mail" style="{{color:&apos;rbga(0,0,0,.25)&apos;}}/">} placeholder=&quot;&#x5BC6;&#x7801;&quot;/&gt;)
                            }
                           </formitem>
                        )
                    }
                {
                        !isLogin&amp;&amp;(
                            <formitem label="&#x4F4F;&#x5740;" {...formitemlayout}="">
                            {
                               getFieldDecorator(&apos;address&apos;,{
                                 initialValue:[&quot;guangdong&quot;,&quot;guangzhou&quot;],
                                 rules: [{type:&apos;array&apos;,required:true,message:&apos;&#x5FC5;&#x987B;&#x8F93;&#x5165;&#x5408;&#x6CD5;&#x7684;&#x5730;&#x5740;&apos;}]
                                })(<cascader options="{addresses}/">)
                            }
                          </cascader></formitem>
                        )
                }
                {
                        !isLogin&amp;&amp;(
                            <formitem label="&#x624B;&#x673A;&#x53F7;" {...formitemlayout}="">
                            {
                               getFieldDecorator(&apos;phone&apos;,{
                                 rules: [{required:true,message:&apos;&#x5FC5;&#x987B;&#x8F93;&#x5165;&#x5408;&#x6CD5;&#x7684;&#x624B;&#x673A;&#x53F7;&apos;}]
                               })(<input addonbefore="{countrySelector}" style="{{width:&apos;100%&apos;}}/">)
                            }
                           </formitem>
                        )
                }
                {
                        !isLogin&amp;&amp;(
                            <formitem label="&#x4E2A;&#x4EBA;&#x4E3B;&#x9875;" {...formitemlayout}="">
                            {
                               getFieldDecorator(&apos;website&apos;,{
                                 rules: [{required:true,message:&apos;&#x5FC5;&#x987B;&#x8F93;&#x5165;&#x5408;&#x6CD5;&#x7684;&#x7F51;&#x5740;&apos;}]
                            })(
                                <autocomplete datasource="{websiteOptions}" onchange="{this.handleWebsiteChange}" placeholder="&#x7F51;&#x5740;">
                                    <input>
                                </autocomplete>
                            )
                                }
                            </formitem>
                        )
                }
                {
                        !isLogin&amp;&amp;(
                            <formitem label="&#x9A8C;&#x8BC1;&#x7801;" {...formitemlayout}="" extra="&#x8BC1;&#x660E;&#x4F60;&#x4E0D;&#x662F;&#x673A;&#x5668;&#x4EBA;">
                              <row gutter="{8}">
                                
                                {
                                       getFieldDecorator(&apos;captcha&apos;,{
                                         rules: [{required:true,message:&apos;&#x5FC5;&#x987B;&#x8F93;&#x5165;&#x9A8C;&#x8BC1;&#x7801;&apos;}]
                                   })(<input>)
                                }
                                
                                
                                    <button>&#x83B7;&#x53D6;&#x9A8C;&#x8BC1;&#x7801;</button>
                                
                              </row>
                           </formitem>
                        )
                    }
                {
                        !isLogin&amp;&amp;(
                            <formitem {...tailformitemlayout}="">
                                {getFieldDecorator(&apos;agreement&apos;, {
                                    valuePropName: &apos;checked&apos;,
                                })(
                                    <checkbox>&#x6211;&#x5DF2;&#x7ECF;&#x9605;&#x8BFB;&#x5E76;&#x540C;&#x610F; <a href="">&#x534F;&#x8BAE;</a></checkbox>
                                )}
                            </formitem>
                        )
                }
                {
                        isLogin?(<formitem>
                                    <button type="primary" htmltype="submit" style="{{width:&apos;100%&apos;}}">&#x767B;&#x5F55;</button>
                                        &#x6CA1;&#x6709;&#x8D26;&#x53F7;? <a href="#" onclick="{this.props.changeLoginStatus}">&#x7ACB;&#x523B;&#x6CE8;&#x518C;!</a>
                                    </formitem>):(
                                <formitem>
                               <button type="primary" htmltype="submit" style="{{width:&apos;100%&apos;}}">&#x6CE8;&#x518C;</button>
                            &#x5DF2;&#x6709;&#x8D26;&#x53F7;? <a href="#" onclick="{this.props.changeLoginStatus}">&#x7ACB;&#x5373;&#x767B;&#x5F55;!</a>
                                </formitem>
                        )
                }
                </form>
            </formwrapper>

        )
  }
}
const WrappedLoginForm = Form.create()(LoginForm);
const FormWrapper=styled.div`
   display:flex;
   justify-content:center;
   align-items:center;
   height:calc(100vh - 70px);
   h3 {
    text-align:center;
   }
   form {
       border:1px solid #999;
       border-radius:5px;
       padding:20px;
   }
`
</code></pre>
<h3 id="t43.2 utils/request.js">3.2 utils/request.js <a href="#t43.2 utils/request.js"> # </a></h3>
<p>src/utils/request.js</p>
<pre><code class="lang-js">import fetch from &apos;dva/fetch&apos;;
const BaseURL=&apos;http://127.0.0.1:7001&apos;;
function parseJSON(response) {
  return response.json();
}

function checkStatus(response) {
  if (response.status &gt;= 200 &amp;&amp; response.status &lt; 300) {
    return response;
  }

  const error = new Error(response.statusText);
  error.response = response;
  throw error;
}
function checkCode(response) {
  if (response.code === 0) {
    return response.data;
  }
  const error = new Error(response.error);
  error.response = response;
  throw error;
}

export default function request(url,options={}) {
  let token=localStorage.getItem(&apos;token&apos;);
  if (token) {
    options.headers=options.headers||{};
    options.headers.authorization=token;
  }
  options.credentials=&quot;include&quot;;
  return fetch(`${BaseURL}${url}`, options)
  .then(checkStatus)
  .then(parseJSON)
  .then(checkCode)
  .catch(err =&gt; ({ err }));
}

</code></pre>
<h3 id="t53.3  models/login.js">3.3  models/login.js <a href="#t53.3  models/login.js"> # </a></h3>
<p>src/pages/login/models/login.js</p>
<pre><code class="lang-js">import * as service from &apos;../services/login&apos;;
import {routerRedux} from &apos;dva/router&apos;;
import {decode} from &apos;jsonwebtoken&apos;;
const entity=&apos;login&apos;;
export default {
    namespace:entity,
    state: {
        isLogin: true,
        errorInfo: &apos;&apos;,
        userInfo:null
    },

    subscriptions: {
        setup({dispatch,history}) {
            history.listen(({pathname,query}) =&gt; {
                if (pathname == &apos;/login&apos;) {

                } else if (pathname == &apos;/signup&apos;) {

                }
            });
        }
    },
    effects: {
        *signup({payload},{call,put}) {
            yield call(service.signup,payload);
            yield put({type:&apos;changeLoginStatus&apos;});
        },
        *login({payload},{call,put}) {
            const token=yield call(service.login,payload);
            const user = decode(token);
            yield put({type:&apos;setUserInfo&apos;,payload:user});
            localStorage.setItem(&apos;token&apos;,token);
            yield put(routerRedux.push(&apos;/admin&apos;));
        },
        *loadUser({payload},{call,put}) {
            let token=localStorage.getItem(&apos;token&apos;);
            if (token) {
                const user = decode(token);
                yield put({type:&apos;setUserInfo&apos;,payload:user});
            } else {
                yield put(routerRedux.push(&apos;/login&apos;));
            }
        }
    },

    reducers: {
        //&#x4FEE;&#x6539;&#x662F;&#x767B;&#x5F55;&#x8FD8;&#x662F;&#x6CE8;&#x518C;&#x7684;&#x72B6;&#x6001;
        changeLoginStatus(state, action) {
           return { ...state,  isLogin:!state.isLogin};
        },
        setErrorInfo(state,{payload}) {
            return { ...state,  errorInfo:payload};
        },
        setUserInfo(state,{payload}) {
            return { ...state,  userInfo:payload};
        }
    },

  };
</code></pre>
<h3 id="t63.4 login/services/login.js">3.4 login/services/login.js <a href="#t63.4 login/services/login.js"> # </a></h3>
<p>src/pages/login/services/login.js</p>
<pre><code class="lang-js">import request from &apos;../../../utils/request&apos;;
export function signup(values) {
  return request(`/signup`,{
    method: &apos;POST&apos;,
    headers:{&quot;Content-Type&quot;:&quot;application/json&quot;},
    body:JSON.stringify(values)
  });
}
export function login(values) {
  return request(`/login`,{
    method: &apos;POST&apos;,
    headers:{&quot;Content-Type&quot;:&quot;application/json&quot;},
    body:JSON.stringify(values)
  });
}
</code></pre>
<h2 id="t74.&#x9A8C;&#x8BC1;&#x7801;">4.&#x9A8C;&#x8BC1;&#x7801; <a href="#t74.&#x9A8C;&#x8BC1;&#x7801;"> # </a></h2>
<h3 id="t84.1 login/index.js">4.1 login/index.js <a href="#t84.1 login/index.js"> # </a></h3>
<p>src/pages/login/index.js</p>
<pre><code class="lang-js">const captchaUrl=`http://127.0.0.1:7001/captcha?ts=`;
<formitem label="&#x9A8C;&#x8BC1;&#x7801;" {...formitemlayout}="" extra="&#x8BC1;&#x660E;&#x4F60;&#x4E0D;&#x662F;&#x673A;&#x5668;&#x4EBA;">
     <row gutter="{8}">
          
              {
                  getFieldDecorator(&apos;captcha&apos;,{
                      rules: [{required:true,message:&apos;&#x5FC5;&#x987B;&#x8F93;&#x5165;&#x9A8C;&#x8BC1;&#x7801;&apos;}]
                  })(<input>)
              }
          
          
                 <img src="{captchaUrl}" onclick="{this.refreshCaptcha}/">
          
    </row>
</formitem>
</code></pre>
<h2 id="t95.&#x540E;&#x53F0;&#x7BA1;&#x7406;&#x754C;&#x9762;&#x5E03;&#x5C40;&#x6A21;&#x7248;">5.&#x540E;&#x53F0;&#x7BA1;&#x7406;&#x754C;&#x9762;&#x5E03;&#x5C40;&#x6A21;&#x7248; <a href="#t95.&#x540E;&#x53F0;&#x7BA1;&#x7406;&#x754C;&#x9762;&#x5E03;&#x5C40;&#x6A21;&#x7248;"> # </a></h2>
<h3 id="t105.1 /admin/_layout.js">5.1 /admin/_layout.js <a href="#t105.1 /admin/_layout.js"> # </a></h3>
<p>src/pages/admin/_layout.js</p>
<pre><code class="lang-js">import React,{Component,Fragment} from &apos;react&apos;;
import { Layout } from &apos;antd&apos;;
const { Header, Footer, Sider, Content } = Layout;
export default class Admin extends Component{
    render() {
        return (
            <layout>
                <header>Header</header>
                <layout>
                    <sider>Sider</sider>
                    <content>Content</content>
                </layout>
                <footer>
                   &#x73E0;&#x5CF0;&#x57F9;&#x8BAD; &#xA9;2018
                </footer>
            </layout>
       )
   }
}
</code></pre>
<h2 id="t116. &#x9876;&#x90E8;&#x5BFC;&#x822A;&#x6761;">6. &#x9876;&#x90E8;&#x5BFC;&#x822A;&#x6761; <a href="#t116. &#x9876;&#x90E8;&#x5BFC;&#x822A;&#x6761;"> # </a></h2>
<h3 id="t126.1 src/components/AdminHeader.js">6.1 src/components/AdminHeader.js <a href="#t126.1 src/components/AdminHeader.js"> # </a></h3>
<pre><code class="lang-js">import React,{Component} from &apos;react&apos;;
import {Layout} from &apos;antd&apos;;
import {connect} from &apos;dva&apos;;
const {Header}=Layout;
class AdminHeader extends Component{
  componentWillMount() {
      this.props.dispatch({
          type:&apos;login/loadUser&apos;
      });
  }
  render() {
    let {userInfo}=this.props;
      return (
        <header>
          <img classname="logo" src="http://img.zhufengpeixun.cn/zfpxlogo.png" alt="logo">
          <span classname="welcome">&#x6B22;&#x8FCE;&#x767B;&#x5F55; {userInfo&amp;&amp;userInfo.username}</span>
        </header>
      )
  }
}
export default connect(
  state =&gt; state.login
)(AdminHeader);

</code></pre>
<h3 id="t136.2 src/global.less">6.2 src/global.less <a href="#t136.2 src/global.less"> # </a></h3>
<p>src/global.less</p>
<pre><code class="lang-less">.ant-layout .ant-layout-header {
  .logo{
      width:120px;
      height:32px;
      margin:16px;
      float:left;
  }
  .welcome{
      float:right;
      color:#FFF;
  }
}
</code></pre>
<h3 id="t146.3 admin/_layout.js">6.3 admin/_layout.js <a href="#t146.3 admin/_layout.js"> # </a></h3>
<p>src/pages/admin/_layout.js</p>
<pre><code class="lang-js">import React,{Component} from &apos;react&apos;;
import { Layout } from &apos;antd&apos;;
import AdminHeader from &apos;../../components/AdminHeader&apos;;
const {Footer,Sider,Content}=Layout;
export default class Admin extends Component{
    render() {
        return (
            <layout>
                <adminheader>
                <layout>
                    <sider>Sider</sider>
                    <content>Content</content>
                </layout>
                <footer>
                   &#x73E0;&#x5CF0;&#x57F9;&#x8BAD; &#xA9;2018
                </footer>
            </adminheader></layout>
       )
   }
}
</code></pre>
<h2 id="t157.&#x5DE6;&#x4FA7;&#x83DC;&#x5355;&#x548C;&#x7528;&#x6237;&#x9875;&#x9762;">7.&#x5DE6;&#x4FA7;&#x83DC;&#x5355;&#x548C;&#x7528;&#x6237;&#x9875;&#x9762; <a href="#t157.&#x5DE6;&#x4FA7;&#x83DC;&#x5355;&#x548C;&#x7528;&#x6237;&#x9875;&#x9762;"> # </a></h2>
<h3 id="t167.1 components/MenuList.js">7.1 components/MenuList.js <a href="#t167.1 components/MenuList.js"> # </a></h3>
<p>src/components/MenuList.js</p>
<pre><code class="lang-js">import React,{Component,Fragment} from &apos;react&apos;;
import {Menu,Icon} from &apos;antd&apos;;
import Link from &apos;umi/link&apos;;
import {connect} from &apos;dva&apos;;
const SubMenu=Menu.SubMenu;
class MenuList extends Component{
    renderMenus=(resources=[]) =&gt; {
        return resources.map(resource =&gt; {
            if (resource.children.length&gt;0) {
                return (
                    <submenu key="{resource.key}" title="{&lt;span"><icon type="{resource.icon}">{resource.name}}&gt;
                        {this.renderMenus(resource.children)}
                    </icon></submenu>
                )    
            } else {
                return <menu.item key="{resource.key}"><link to="{resource.key}"><icon type="{resource.icon}">{resource.name}</icon></menu.item>;
            }
        });
    }
    render() {
        let {userInfo}=this.props;
        if (!userInfo)
            return null;
        return (
            <menu theme="dark" defaultselectedkeys="{[&apos;/admin&apos;]}" defaultopenkeys="{[&apos;/admin&apos;]}" mode="inline">
                {
                    this.renderMenus(userInfo.resources)
                }
            </menu>
        )
    }
}
export default connect(
    state =&gt; state.login
  )(MenuList);
</code></pre>
<h3 id="t177.2 admin/_layout.js">7.2 admin/_layout.js <a href="#t177.2 admin/_layout.js"> # </a></h3>
<p>src/pages/admin/_layout.js</p>
<pre><code class="lang-js">import React,{Component} from &apos;react&apos;;
import { Layout } from &apos;antd&apos;;
import AdminHeader from &apos;../../components/AdminHeader&apos;;
import MenuList from &apos;../../components/MenuList&apos;;
const {Footer,Sider,Content}=Layout;
export default class Admin extends Component{
    render() {
        return (
            <layout>
                <adminheader>
                <layout>
                    <sider>
                        <menulist>
                    </menulist></sider>
                    <content>
                        {this.props.children}
                    </content>
                </layout>
                <footer>
                   &#x73E0;&#x5CF0;&#x57F9;&#x8BAD; &#xA9;2018
                </footer>
            </adminheader></layout>
       )
   }
}
</code></pre>
<h2 id="t187. &#x7528;&#x6237;&#x7BA1;&#x7406;">7. &#x7528;&#x6237;&#x7BA1;&#x7406; <a href="#t187. &#x7528;&#x6237;&#x7BA1;&#x7406;"> # </a></h2>
<h3 id="t197.1 src/utils/request.js">7.1 src/utils/request.js <a href="#t197.1 src/utils/request.js"> # </a></h3>
<pre><code class="lang-js">import fetch from &apos;dva/fetch&apos;;
const BaseURL=&apos;http://127.0.0.1:7001&apos;;
function parseJSON(response) {
  return response.json();
}

function checkStatus(response) {
  if (response.status &gt;= 200 &amp;&amp; response.status &lt; 300) {
    return response;
  }

  const error = new Error(response.statusText);
  error.response = response;
  throw error;
}
function checkCode(response) {
  if (response.code === 0) {
    return response.data;
  }
  const error = new Error(response.error);
  error.response = response;
  throw error;
}

export default function request(url,options={}) {
  let token=localStorage.getItem(&apos;token&apos;);
  if (token) {
    options.headers=options.headers||{};
    options.headers.authorization=token;
  }
  options.credentials=&quot;include&quot;;
  return fetch(`${BaseURL}${url}`, options)
  .then(checkStatus)
  .then(parseJSON)
  .then(checkCode)
  .catch(err =&gt; ({ err }));
}
</code></pre>
<h3 id="t207.2 admin/user/index.js">7.2 admin/user/index.js <a href="#t207.2 admin/user/index.js"> # </a></h3>
<p>src/pages/admin/user/index.js</p>
<pre><code class="lang-js">import React,{Component,Fragment} from &apos;react&apos;;
import {connect} from &apos;dva&apos;;
import {Card,Table,Button,Modal,Form,Input,message,Popconfirm} from &apos;antd&apos;;
import {PAGE_SIZE} from &apos;./constants&apos;;
import { routerRedux } from &apos;dva/router&apos;;
const FormItem=Form.Item;
@connect(
    state =&gt; ({...state.user,loading:state.loading.models.user})
)
export default class user extends Component{
    save = (payload) =&gt; {
        this.props.dispatch({
            type: &apos;user/save&apos;,
            payload
        });
    }
    onAdd=() =&gt; {
        this.save({editVisible: true,isCreate:true,record: {} });
    }
    onEdit=(record) =&gt; {
        this.save({editVisible: true,isCreate:false,record});
    }
    onEditCancel=() =&gt; {
        this.save({ editVisible : false });
    }
    onEditOk=() =&gt; {
        this.editForm.props.form.validateFields((err,values) =&gt; {
            if (err) {
                return message.error(&apos;&#x8868;&#x5355;&#x6821;&#x9A8C;&#x5931;&#x8D25;!&apos;);
            } else {
                this.props.dispatch({
                    type: this.props.isCreate?&apos;user/create&apos;:&apos;user/update&apos;,
                    payload:values
                });
            }
        });
    }
    onDel=(id) =&gt; {
        this.props.dispatch({
            type: &apos;user/del&apos;,
            payload:id
        });
    }
    render() {
        const columns=[
            {
                title: &apos;&#x7528;&#x6237;&#x540D;&apos;,
                dataIndex: &apos;username&apos;,
                key: &apos;username&apos;
            },
            {
                title: &apos;&#x90AE;&#x7BB1;&apos;,
                dataIndex: &apos;email&apos;,
                key: &apos;email&apos;
            },
            {
                title: &apos;&#x6027;&#x522B;&apos;,
                dataIndex: &apos;gender&apos;,
                key: &apos;gender&apos;,
                render: (val,record)=&gt;(
                    val==1?&apos;&#x7537;&apos;:&apos;&#x5973;&apos;
                )
            },
            {
                title: &apos;&#x64CD;&#x4F5C;&apos;,
                key: &apos;operation&apos;,
                render: (val,record) =&gt; (
                    <fragment>
                        <button type="warning" onclick="{()=">this.onEdit(record)}&gt;&#x7F16;&#x8F91;</button>
                        <popconfirm oktext="&#x786E;&#x8BA4;" canceltext="&#x53D6;&#x6D88;" title="&#x786E;&#x8BA4;&#x5220;&#x9664;&#x6B64;&#x7528;&#x6237;&#x5417;?" onconfirm="{()" ==""> this.onDel(record.id)}&gt;
                             <button type="danger">&#x5220;&#x9664;</button>
                        </popconfirm>
                    </fragment>
                )
            }
        ]
        let {list,record,isCreate,editVisible,loading,dispatch,pageNum,total}=this.props;
        const pagination={
            current: pageNum,
            pageSize: PAGE_SIZE,
            showQuickJumper: true,
            showTotal: (total,range) =&gt; {
                return `&#x5171;${total}&#x6761;`;
            },
            total,
            onChange: (pageNum) =&gt; {
                //router.push(`/admin/user?pageNum=${pageNum}`);
                //dispatch(routerRedux.push(`/admin/user?pageNum=${pageNum}`));
                dispatch(routerRedux.push({
                    pathname: &apos;/admin/user&apos;,
                    query:{pageNum}
                }));
            }
        }
        const rowSelection={
            type: &apos;checkbox&apos;,
            selectedRowKeys: this.props.selectedRowKeys,
            onChange: (selectedRowKeys) =&gt; {
                this.save({selectedRowKeys});
            }
        }
        return (
            <card>
                <button type="warning" onclick="{this.onAdd}">&#x6DFB;&#x52A0;</button>
                 record.id}
                    pagination={pagination}
                    rowSelection={rowSelection}
                /&gt;
                <editmodal wrappedcomponentref="{instance" =="">this.editForm=instance}
                    isCreate={isCreate}
                    visible={editVisible}
                    onOk={this.onEditOk}
                    onCancel={this.onEditCancel}
                    record={record}
                /&gt;
            
        )
    }
}

@Form.create()
class EditModal extends Component{
    render() {
        let {visible,onOk,isCreate,onCancel,record,form: {getFieldDecorator}}=this.props;
        let {username,email,id}=record;
        return (
            <modal title="{isCreate?&apos;&#x521B;&#x5EFA;&#x7528;&#x6237;&apos;:&apos;&#x4FEE;&#x6539;&#x7528;&#x6237;&apos;}" visible="{visible}" onok="{onOk}" oncancel="{onCancel}" destroyonclose="">
                <form></form>
                    <formitem>
                       {
                            getFieldDecorator(&apos;id&apos;,{
                                initialValue: id
                            })(<input type="hidden">)
                        }
                    </formitem>
                    <formitem label="&#x7528;&#x6237;&#x540D;">
                        {
                            getFieldDecorator(&apos;username&apos;,{
                                rules: [{
                                    required: true,
                                    message:&apos;&#x7528;&#x6237;&#x540D;&#x5FC5;&#x987B;&#x8F93;&#x5165;&apos;
                                }],
                                initialValue: username
                            })(<input>)
                        }
                    </formitem>
                    <formitem label="&#x90AE;&#x7BB1;">
                        {
                            getFieldDecorator(&apos;email&apos;,{
                                initialValue: email,
                                rules: [{required: true,message:&apos;&#x7528;&#x6237;&#x540D;&#x5FC5;&#x987B;&#x8F93;&#x5165;&apos;
                            }]})(<input>)
                        }
                    </formitem>
                
            </modal>
        )
    }
}
</editmodal><table columns="{columns}" datasource="{list}" loading="{loading}" rowkey="{record" ==""></table></card></code></pre>
<h3 id="t217.3 /user/constants.js">7.3 /user/constants.js <a href="#t217.3 /user/constants.js"> # </a></h3>
<p>src/pages/admin/user/constants.js</p>
<pre><code class="lang-js">export  const PAGE_SIZE = 3;
</code></pre>
<h3 id="t227.4 /user/models/user.js">7.4 /user/models/user.js <a href="#t227.4 /user/models/user.js"> # </a></h3>
<p>src/pages/admin/user/models/user.js</p>
<pre><code class="lang-js">import * as userService from &apos;../services/user&apos;;

export default {
    namespace: &apos;user&apos;,
    state: {
        list: [],
        isCreate:true,
        editVisible: false,
        pageNum:1,
        record: {},
        selectedRowKeys:[]
    },
    reducers: {
        save(state,{payload}) {
            return {...state,...payload};
        }
    },
    effects: {
        *fetch({payload: {pageNum=1}},{call,put}) {
            const {list,total}=yield call(userService.fetch,pageNum);
            yield put({type:&apos;save&apos;,payload:{list,pageNum:parseInt(pageNum),total}});
        },
        *create({payload},{call,put}) {
            yield call(userService.create,payload);
            yield put({type: &apos;fetch&apos;,payload: {pageNum:1}});
            yield put({type:&apos;save&apos;,payload:{editVisible:false}});
        },
        *update({payload},{call,put,select}) {
            yield call(userService.update,payload);
            let pageNum=yield select(state=&gt;state.user.pageNum);
            yield put({type: &apos;fetch&apos;,payload: {pageNum}});
            yield put({type:&apos;save&apos;,payload:{editVisible:false}});
        },
        *del({payload},{call,put}) {
            yield call(userService.del,payload);
            yield put({type: &apos;fetch&apos;,payload: {pageNum:1}});
        }
    },
    subscriptions: {
        setup({dispatch,history}) {
            return history.listen(({pathname,query}) =&gt; {
                if (pathname===&apos;/admin/user&apos;) {
                    console.log(&apos;pathname&apos;,pathname);
                    dispatch({type:&apos;fetch&apos;,payload:query});
                }
            });
        }
    }
}
</code></pre>
<h3 id="t237.5 user/services/user.js">7.5 user/services/user.js <a href="#t237.5 user/services/user.js"> # </a></h3>
<p>src/pages/admin/user/services/user.js</p>
<pre><code class="lang-js">import request from &apos;../../../../utils/request&apos;;
import {PAGE_SIZE} from &apos;../constants&apos;;
export function fetch(pageNum) {
    return request(`/user?pageNum=${pageNum}&amp;pageSize=${PAGE_SIZE}`);
}

export function create(values) {
    return request(`/user`,{
        method: &apos;POST&apos;,
        headers:{&quot;Content-Type&quot;:&quot;application/json&quot;},
        body:JSON.stringify(values)
    });
}
export function update(values) {
    return request(`/user/${values.id}`,{
        method: &apos;PUT&apos;,
        headers:{&quot;Content-Type&quot;:&quot;application/json&quot;},
        body:JSON.stringify(values)
    });
}

export function del(id) {
    return request(`/user/${id}`,{
        method: &apos;DELETE&apos;
    });
}
</code></pre>
<h2 id="t248. &#x5168;&#x90E8;&#x5220;&#x9664;">8. &#x5168;&#x90E8;&#x5220;&#x9664; <a href="#t248. &#x5168;&#x90E8;&#x5220;&#x9664;"> # </a></h2>
<h3 id="t258.1 user/index.js">8.1 user/index.js <a href="#t258.1 user/index.js"> # </a></h3>
<p>src/pages/admin/user/index.js</p>
<pre><code class="lang-diff">+ onAllDel=() =&gt; {
+         this.props.dispatch({
+             type: &apos;user/delAll&apos;,
+             payload:this.props.selectedRowKeys
+         });
+     }
  <button type="warning" onclick="{this.onAdd}">&#x6DFB;&#x52A0;</button>
+ <button type="danger" onclick="{this.onAllDel}">&#x5168;&#x90E8;&#x5220;&#x9664;</button>
</code></pre>
<h3 id="t268.2 user/models/user.js">8.2 user/models/user.js <a href="#t268.2 user/models/user.js"> # </a></h3>
<p>src/pages/admin/user/models/user.js</p>
<pre><code class="lang-diff">+ *delAll({payload},{call,put}) {
+             yield call(userService.delAll,payload);
+             yield put({type: &apos;fetch&apos;,payload: {pageNum:1}});
+ }
</code></pre>
<h3 id="t278.3 user/services/user.js">8.3 user/services/user.js <a href="#t278.3 user/services/user.js"> # </a></h3>
<p>src/pages/admin/user/services/user.js</p>
<pre><code class="lang-diff">export function delAll(ids) {
    return request(`/user/${ids[0]}`,{
        method: &apos;DELETE&apos;,
        headers: {&quot;Content-Type&quot;: &quot;application/json&quot;},
        body: JSON.stringify(ids)
    });
}
</code></pre>
<h2 id="t289. &#x641C;&#x7D22;">9. &#x641C;&#x7D22; <a href="#t289. &#x641C;&#x7D22;"> # </a></h2>
<h3 id="t299.1 admin/user/index.js">9.1 admin/user/index.js <a href="#t299.1 admin/user/index.js"> # </a></h3>
<p>src/pages/admin/user/index.js</p>
<pre><code class="lang-diff">onSearch=() =&gt; {
        let values=this.searchForm.props.form.getFieldsValue();
        let where=Object.keys(values).reduce((memo,key) =&gt; {
            if (values[key]){
                memo[key]=values[key];
            }
            return memo;
        },{});
        this.props.dispatch({
            type: &apos;user/search&apos;,
            payload:where
        });
    }

<card>
    <searchform where="{where}" onsearch="{this.onSearch}" wrappedcomponentref="{inst=">this.searchForm=inst}/&gt;
</searchform></card>

@Form.create()
class SearchForm extends Component{
    render() {
        let {form: {getFieldDecorator},onSearch,where={}}=this.props;
        return (
            <form layout="inline">
                    <formitem label="&#x7528;&#x6237;&#x540D;">
                        {
                            getFieldDecorator(&apos;username&apos;,{initialValue:where.username})(<input>)
                        }
                    </formitem>
                    <formitem label="&#x90AE;&#x7BB1;">
                        {
                            getFieldDecorator(&apos;email&apos;,{initialValue:where.email})(<input>)
                        }
                </formitem>
                <formitem>
                    <button onclick="{onSearch}" shape="circle" icon="search"></button>
                </formitem>
                </form>
        )
    }
}

</code></pre>
<h3 id="t309.2 user/models/user.js">9.2 user/models/user.js <a href="#t309.2 user/models/user.js"> # </a></h3>
<p>src/pages/admin/user/models/user.js</p>
<pre><code class="lang-js">        *fetch({payload: {pageNum,where}},{call,put,select}) {
            if (!where) {
                where =yield select(state =&gt; state.user.where);
            }
            if (!pageNum) {
                pageNum =yield select(state =&gt; state.user.pageNum);
            }
            const {list,total}=yield call(userService.fetch,pageNum,where);
            yield put({type:&apos;save&apos;,payload:{list,pageNum:parseInt(pageNum),total,where}});
        },
        *search({payload:where},{call,put}) {
            yield put({type: &apos;fetch&apos;,payload: {pageNum:1,where}});
        }
</code></pre>
<h3 id="t319.3 user/services/user.js">9.3 user/services/user.js <a href="#t319.3 user/services/user.js"> # </a></h3>
<p>src/pages/admin/user/services/user.js</p>
<pre><code class="lang-js">import querystring from &apos;querystring&apos;;
export function fetch(pageNum,where) {
    let whereString=querystring.stringify(where);
    return request(`/user?pageNum=${pageNum}&amp;pageSize=${PAGE_SIZE}&amp;${whereString}`);
}
</code></pre>
<h2 id="t3210. &#x70B9;&#x51FB;&#x9009;&#x62E9;&#x884C;">10. &#x70B9;&#x51FB;&#x9009;&#x62E9;&#x884C; <a href="#t3210. &#x70B9;&#x51FB;&#x9009;&#x62E9;&#x884C;"> # </a></h2>
<h3 id="t3310.1 admin/user/index.js">10.1 admin/user/index.js <a href="#t3310.1 admin/user/index.js"> # </a></h3>
<p>src/pages/admin/user/index.js</p>
<pre><code class="lang-js">  record.id}
                    pagination={pagination}
                    rowSelection={rowSelection}
                    onRow = {
+                      (record) =&gt; {
+                        return {
+                          onClick: () =&gt; {
+                            let selectedRowKeys = this.props.selectedRowKeys;
+                            let index = selectedRowKeys.indexOf(record.id);
+                            if (index == -1) {
+                              selectedRowKeys = [...selectedRowKeys, record.id];
+                            } else {
+                              selectedRowKeys = selectedRowKeys.filter(key =&gt; key !=record.id);
+                            }
+                            this.save({
+                              selectedRowKeys
+                            });
+                          }
+                        }
+                      }
+                    }
                /&gt;
<table columns="{columns}" datasource="{list}" loading="{loading}" rowkey="{record" ==""></table></code></pre>
<h2 id="t3411. &#x89D2;&#x8272;&#x7BA1;&#x7406;">11. &#x89D2;&#x8272;&#x7BA1;&#x7406; <a href="#t3411. &#x89D2;&#x8272;&#x7BA1;&#x7406;"> # </a></h2>
<h3 id="t3511.1 /role/index.js">11.1 /role/index.js <a href="#t3511.1 /role/index.js"> # </a></h3>
<p>src/pages/role/index.js</p>
<pre><code class="lang-js">import React,{Component,Fragment} from &apos;react&apos;;
import {connect} from &apos;dva&apos;;
import {Card,Table,Button,Modal,Form,Input,message,Popconfirm} from &apos;antd&apos;;
import {PAGE_SIZE} from &apos;./constants&apos;;
import { routerRedux } from &apos;dva/router&apos;;
const FormItem=Form.Item;
const ENTITY=&apos;role&apos;;
@connect(
    state =&gt; ({...state[ENTITY],loading:state.loading.models[ENTITY]})
)
export default class Role extends Component{
    save = (payload) =&gt; {
        this.props.dispatch({
            type: `${ENTITY}/save`,
            payload
        });
    }
    onAdd=() =&gt; {
        this.save({editVisible: true,isCreate:true,record: {} });
    }
    onEdit=(record) =&gt; {
        this.save({editVisible: true,isCreate:false,record});
    }
    onEditCancel=() =&gt; {
        this.save({ editVisible : false });
    }
    onEditOk=() =&gt; {
        this.editForm.props.form.validateFields((err,values) =&gt; {
            if (err) {
                return message.error(&apos;&#x8868;&#x5355;&#x6821;&#x9A8C;&#x5931;&#x8D25;!&apos;);
            } else {
                this.props.dispatch({
                    type: this.props.isCreate?`${ENTITY}/create`:`${ENTITY}/update`,
                    payload:values
                });
            }
        });
    }
    onDel=(id) =&gt; {
        this.props.dispatch({
            type: `${ENTITY}/del`,
            payload:id
        });
    }
    onAllDel=() =&gt; {
        this.props.dispatch({
            type: `${ENTITY}/delAll`,
            payload:this.props.selectedRowKeys
        });
    }
    onSearch=() =&gt; {
        let values=this.searchForm.props.form.getFieldsValue();
        let where=Object.keys(values).reduce((memo,key) =&gt; {
            if (values[key]){
                memo[key]=values[key];
            }
            return memo;
        },{});
        this.props.dispatch({
            type: `${ENTITY}/search`,
            payload:where
        });
    }
    render() {
        const columns=[
            {
                title: &apos;&#x540D;&#x79F0;&apos;,
                dataIndex: &apos;name&apos;,
                key: &apos;name&apos;
            },
            {
                title: &apos;&#x64CD;&#x4F5C;&apos;,
                key: &apos;operation&apos;,
                render: (val,record) =&gt; (
                    <fragment>
                        <button type="warning" onclick="{()=">this.onEdit(record)}&gt;&#x7F16;&#x8F91;</button>
                        <popconfirm oktext="&#x786E;&#x8BA4;" canceltext="&#x53D6;&#x6D88;" title="&#x786E;&#x8BA4;&#x5220;&#x9664;&#x5417;?" onconfirm="{()" ==""> this.onDel(record.id)}&gt;
                             <button type="danger">&#x5220;&#x9664;</button>
                        </popconfirm>
                    </fragment>
                )
            }
        ]
        let {list,record,isCreate,editVisible,loading,dispatch,pageNum,total,where}=this.props;
        const pagination={
            current: pageNum,
            pageSize: PAGE_SIZE,
            showQuickJumper: true,
            showTotal: (total,range) =&gt; {
                return `&#x5171;${total}&#x6761;`;
            },
            total,
            onChange: (pageNum) =&gt; {
                //router.push(`/admin/user?pageNum=${pageNum}`);
                //dispatch(routerRedux.push(`/admin/user?pageNum=${pageNum}`));
                dispatch(routerRedux.push({
                    pathname: `/admin/${ENTITY}`,
                    query:{pageNum}
                }));
            }
        }
        const rowSelection={
            type: &apos;checkbox&apos;,
            selectedRowKeys: this.props.selectedRowKeys,
            onChange: (selectedRowKeys) =&gt; {
                this.save({selectedRowKeys});
            }
        }
        return (
            <fragment>
              <card>
                    <searchform where="{where}" onsearch="{this.onSearch}" wrappedcomponentref="{inst=">this.searchForm=inst}/&gt;
              </searchform></card>
              <card>
                <button type="warning" onclick="{this.onAdd}">&#x6DFB;&#x52A0;</button>
                <button type="danger" onclick="{this.onAllDel}">&#x5168;&#x90E8;&#x5220;&#x9664;</button>
                 record.id}
                    pagination={pagination}
                    rowSelection={rowSelection}
                    onRow = {
                      (record) =&gt; {
                        return {
                          onClick: () =&gt; {
                            let selectedRowKeys = this.props.selectedRowKeys;
                            let index = selectedRowKeys.indexOf(record.id);
                            if (index == -1) {
                              selectedRowKeys = [...selectedRowKeys, record.id];
                            } else {
                              selectedRowKeys = selectedRowKeys.filter(key =&gt; key != record.id);
                            }
                            this.save({
                              selectedRowKeys
                            });
                          }
                        }
                      }
                    }
                /&gt;
                <editmodal wrappedcomponentref="{instance" =="">this.editForm=instance}
                    isCreate={isCreate}
                    visible={editVisible}
                    onOk={this.onEditOk}
                    onCancel={this.onEditCancel}
                    record={record}
                /&gt;
                    
             
        )
    }
}

@Form.create()
class SearchForm extends Component{
    render() {
        let {form: {getFieldDecorator},onSearch,where={}}=this.props;
        return (
            <form layout="inline"></form>
                    <formitem label="&#x540D;&#x79F0;">
                        {
                            getFieldDecorator(&apos;name&apos;,{initialValue:where.name})(<input>)
                        }
                    </formitem>
                <formitem>
                    <button onclick="{onSearch}" shape="circle" icon="search"></button>
                </formitem>
                
        )
    }
}


@Form.create()
class EditModal extends Component{
    render() {
        let {visible,onOk,isCreate,onCancel,record,form: {getFieldDecorator}}=this.props;
        let {name,id}=record;
        return (
            <modal title="{isCreate?&apos;&#x521B;&#x5EFA;&apos;:&apos;&#x4FEE;&#x6539;&apos;}" visible="{visible}" onok="{onOk}" oncancel="{onCancel}" destroyonclose="">
                <form></form>
                    <formitem>
                       {
                            getFieldDecorator(&apos;id&apos;,{
                                initialValue: id
                            })(<input type="hidden">)
                        }
                    </formitem>
                    <formitem label="&#x540D;&#x79F0;">
                        {
                            getFieldDecorator(&apos;name&apos;,{
                                rules: [{
                                    required: true,
                                    message:&apos;&#x540D;&#x79F0;&apos;
                                }],
                                initialValue: name
                            })(<input>)
                        }
                    </formitem>
                
            </modal>
        )
    }
}

</editmodal><table columns="{columns}" datasource="{list}" loading="{loading}" rowkey="{record" ==""></table></card></fragment></code></pre>
<h3 id="t3611.2 /role/models/role.js">11.2 /role/models/role.js <a href="#t3611.2 /role/models/role.js"> # </a></h3>
<p>src/pages/admin/role/models/role.js</p>
<pre><code class="lang-js">import * as service from &apos;../services/role&apos;;
const ENTITY=&apos;role&apos;;
export default {
    namespace: ENTITY,
    state: {
        list: [],
        isCreate:true,
        editVisible: false,
        pageNum:1,
        record: {},
        selectedRowKeys: [],
        where: {}
    },
    reducers: {
        save(state,{payload}) {
            return {...state,...payload};
        }
    },
    effects: {
        *fetch({payload: {pageNum,where}},{call,put,select}) {
            if (!where) {
                where =yield select(state =&gt; state[ENTITY].where);
            }
            if (!pageNum) {
                pageNum =yield select(state =&gt; state[ENTITY].pageNum);
            }
            const {list,total}=yield call(service.fetch,pageNum,where);
            yield put({type:&apos;save&apos;,payload:{list,pageNum:parseInt(pageNum),total,where}});
        },
        *create({payload},{call,put}) {
            yield call(service.create,payload);
            yield put({type: &apos;fetch&apos;,payload: {pageNum:1}});
            yield put({type:&apos;save&apos;,payload:{editVisible:false}});
        },
        *update({payload},{call,put,select}) {
            yield call(service.update,payload);
            let pageNum=yield select(state=&gt;state[ENTITY].pageNum);
            yield put({type: &apos;fetch&apos;,payload: {pageNum}});
            yield put({type:&apos;save&apos;,payload:{editVisible:false}});
        },
        *del({payload},{call,put}) {
            yield call(service.del,payload);
            yield put({type: &apos;fetch&apos;,payload: {pageNum:1}});
        },
        *delAll({payload},{call,put}) {
            yield call(service.delAll,payload);
            yield put({type: &apos;fetch&apos;,payload: {pageNum:1}});
        },
        *search({payload:where},{call,put}) {
            yield put({type: &apos;fetch&apos;,payload: {pageNum:1,where}});
        }
    },
    subscriptions: {
        setup({dispatch,history}) {
            return history.listen(({pathname,query}) =&gt; {
                if (pathname===`/admin/${ENTITY}`) {
                    dispatch({type:&apos;fetch&apos;,payload:query});
                }
            });
        }
    }
}
</code></pre>
<h3 id="t3711.3 admin/role/services/role.js">11.3 admin/role/services/role.js <a href="#t3711.3 admin/role/services/role.js"> # </a></h3>
<p>src/pages/admin/role/services/role.js</p>
<pre><code class="lang-js">import request from &apos;../../../../utils/request&apos;;
import {PAGE_SIZE} from &apos;../constants&apos;;
import querystring from &apos;querystring&apos;;
const ENTITY=&apos;role&apos;;
export function fetch(pageNum,where) {
    let whereString=querystring.stringify(where);
    return request(`/${ENTITY}?pageNum=${pageNum}&amp;pageSize=${PAGE_SIZE}&amp;${whereString}`);
}

export function create(values) {
    return request(`/${ENTITY}`,{
        method: &apos;POST&apos;,
        headers:{&quot;Content-Type&quot;:&quot;application/json&quot;},
        body:JSON.stringify(values)
    });
}
export function update(values) {
    return request(`/${ENTITY}/${values.id}`,{
        method: &apos;PUT&apos;,
        headers:{&quot;Content-Type&quot;:&quot;application/json&quot;},
        body:JSON.stringify(values)
    });
}

export function del(id) {
    return request(`/${ENTITY}/${id}`,{
        method: &apos;DELETE&apos;
    });
}
export function delAll(ids) {
    return request(`/${ENTITY}/${ids[0]}`,{
        method: &apos;DELETE&apos;,
        headers: {&quot;Content-Type&quot;: &quot;application/json&quot;},
        body: JSON.stringify(ids)
    });
}
</code></pre>
<h2 id="t3812. &#x8BBE;&#x7F6E;&#x6743;&#x9650;">12. &#x8BBE;&#x7F6E;&#x6743;&#x9650; <a href="#t3812. &#x8BBE;&#x7F6E;&#x6743;&#x9650;"> # </a></h2>
<h3 id="t3912.1 role/index.js">12.1 role/index.js <a href="#t3912.1 role/index.js"> # </a></h3>
<p>src/pages/admin/role/index.js</p>
<pre><code class="lang-js">import React,{Component,Fragment} from &apos;react&apos;;
import {connect} from &apos;dva&apos;;
import {Card,Table,Button,Modal,Form,Input,message,Popconfirm,Tree} from &apos;antd&apos;;
import {PAGE_SIZE} from &apos;./constants&apos;;
import { routerRedux } from &apos;dva/router&apos;;
const FormItem=Form.Item;
const ENTITY=&apos;role&apos;;
const TreeNode=Tree.TreeNode;
@connect(
    state =&gt; ({...state[ENTITY],loading:state.loading.models[ENTITY]})
)
export default class Enity extends Component{
    save = (payload) =&gt; {
        this.props.dispatch({
            type: `${ENTITY}/save`,
            payload
        });
    }
    onAdd=() =&gt; {
        this.save({editVisible: true,isCreate:true,record: {} });
    }
    onEdit=(record) =&gt; {
        this.save({editVisible: true,isCreate:false,record});
    }
    onEditCancel=() =&gt; {
        this.save({ editVisible : false });
    }
    onEditOk=() =&gt; {
        this.editForm.props.form.validateFields((err,values) =&gt; {
            if (err) {
                return message.error(&apos;&#x8868;&#x5355;&#x6821;&#x9A8C;&#x5931;&#x8D25;!&apos;);
            } else {
                this.props.dispatch({
                    type: this.props.isCreate?`${ENTITY}/create`:`${ENTITY}/update`,
                    payload:values
                });
            }
        });
    }
    onDel=(id) =&gt; {
        this.props.dispatch({
            type: `${ENTITY}/del`,
            payload:id
        });
    }
    onAllDel=() =&gt; {
        this.props.dispatch({
            type: `${ENTITY}/delAll`,
            payload:this.props.selectedRowKeys
        });
    }
    onSearch=() =&gt; {
        let values=this.searchForm.props.form.getFieldsValue();
        let where=Object.keys(values).reduce((memo,key) =&gt; {
            if (values[key]){
                memo[key]=values[key];
            }
            return memo;
        },{});
        this.props.dispatch({
            type: `${ENTITY}/search`,
            payload:where
        });
    }
    setRolePermission=() =&gt; {
        if (this.props.selectedRows.length==1) {
            let record=this.props.selectedRows[0];
            this.save({setPermissionVisible:true,record,checkedKeys:record.resourceIds});
        } else {
            message.error(&apos;&#x4E3A;&#x89D2;&#x8272;&#x8BBE;&#x7F6E;&#x6743;&#x9650;&#x65F6;&#x8981;&#x9009;&#x62E9;&#x5E76;&#x4E14;&#x53EA;&#x80FD;&#x9009;&#x62E9;&#x4E00;&#x4E2A;&#x89D2;&#x8272;!&apos;);
        }
    }
    onCheckPermission=(checkedKeys) =&gt; {
        this.save({checkedKeys});
    }
    setRolePermissionOk=() =&gt; {
        this.props.dispatch({
            type: `${ENTITY}/setRolePermission`
        });
    }
    render() {
        const columns=[
            {
                title: &apos;&#x540D;&#x79F0;&apos;,
                dataIndex: &apos;name&apos;,
                key: &apos;name&apos;
            },
            {
                title: &apos;&#x64CD;&#x4F5C;&apos;,
                key: &apos;operation&apos;,
                render: (val,record) =&gt; (
                    <fragment>
                        <button type="warning" onclick="{()=">this.onEdit(record)}&gt;&#x7F16;&#x8F91;</button>
                        <popconfirm oktext="&#x786E;&#x8BA4;" canceltext="&#x53D6;&#x6D88;" title="&#x786E;&#x8BA4;&#x5220;&#x9664;&#x6B64;&#x8BB0;&#x5F55;&#x5417;?" onconfirm="{()" ==""> this.onDel(record.id)}&gt;
                             <button type="danger">&#x5220;&#x9664;</button>
                        </popconfirm>
                    </fragment>
                )
            }
        ]
        let {list,record,isCreate,editVisible,loading,dispatch,page,total,where,setPermissionVisible,resources,checkedKeys}=this.props;
        const pagination={
            current: page,
            pageSize: PAGE_SIZE,
            showQuickJumper: true,
            showTotal: (total,range) =&gt; {
                return `&#x5171;${total}&#x6761;`;
            },
            total,
            onChange: (page) =&gt; {
                //router.push(`/admin/user?page=${page}`);
                //dispatch(routerRedux.push(`/admin/user?page=${page}`));
                dispatch(routerRedux.push({
                    pathname: `/admin/${ENTITY}`,
                    query:{page}
                }));
            }
        }
        const rowSelection={
            type: &apos;checkbox&apos;,
            selectedRowKeys: this.props.selectedRowKeys,
            onChange: (selectedRowKeys,selectedRows) =&gt; {
                this.save({selectedRowKeys,selectedRows});
            }
        }
        return (
            <fragment>
                    <card>
                    <searchform where="{where}" onsearch="{this.onSearch}" wrappedcomponentref="{inst=">this.searchForm=inst}
                /&gt;
            </searchform></card>
            <card>
                <button.group>
                    <button type="warning" onclick="{this.onAdd}">&#x6DFB;&#x52A0;</button>
                    <button type="danger" onclick="{this.onAllDel}">&#x5168;&#x90E8;&#x5220;&#x9664;</button>
                    <button icon="solution" onclick="{this.setRolePermission}">&#x8BBE;&#x7F6E;&#x6743;&#x9650;</button>
                    <button icon="team" onclick="{this.setRoleUser}">&#x7528;&#x6237;&#x6388;&#x6743;</button>
                </button.group>

                 record.id}
                    pagination={pagination}
                        rowSelection={rowSelection}
                        onRow={
                            (record) =&gt; {
                                return {
                                    onClick: () =&gt; {
                                        let selectedRowKeys=this.props.selectedRowKeys;
                                        let selectedRows = this.props.selectedRows;
                                        let index = selectedRowKeys.indexOf(record.id);
                                        if (index==-1) {
                                            selectedRowKeys=[...selectedRowKeys,record.id];
                                            selectedRows=[...selectedRows,record];
                                        } else {
                                            selectedRowKeys=selectedRowKeys.filter(key =&gt; key!=record.id);
                                            selectedRows=selectedRows.filter(row =&gt; row.id!=record.id);
                                        }
                                        this.save({selectedRowKeys,selectedRows});
                                    }
                                }    
                            }
                        }
                /&gt;
                <editmodal wrappedcomponentref="{instance" =="">this.editForm=instance}
                    isCreate={isCreate}
                    visible={editVisible}
                    onOk={this.onEditOk}
                    onCancel={this.onEditCancel}
                    record={record}
                /&gt;
                <permissonmodal visible="{setPermissionVisible}" record="{record}" resources="{resources}" checkedkeys="{checkedKeys}" oncheck="{this.onCheckPermission}" onok="{this.setRolePermissionOk}" oncancel="{()=">this.save({setPermissionVisible:false})}
                /&gt;
            
          
        )
    }
}

@Form.create()
class SearchForm extends Component{
    render() {
        let {form: {getFieldDecorator},onSearch,where={}}=this.props;
        return (
            <form layout="inline"></form>
                    <formitem label="&#x89D2;&#x8272;&#x540D;&#x79F0;">
                        {
                            getFieldDecorator(&apos;name&apos;,{initialValue:where.name})(<input>)
                        }
                    </formitem>
                <formitem>
                    <button onclick="{onSearch}" shape="circle" icon="search"></button>
                </formitem>
                
        )
    }
}

class PermissonModal extends Component{
    renderResources=(children) =&gt; {
        return children.map(child =&gt; {
            if (child.children.length &gt; 0) {
                return (
                    <treenode title="{child.name}" key="{child.id}">
                        {this.renderResources(child.children)}
                    </treenode>
                )
            } else {
                return <treenode title="{child.name}" key="{child.id}/">
            }
        });
    }
    render() {
        let {onCheck,visible,onOk,onCancel,checkedKeys,resources=[]}=this.props;
        return (
            <modal visible="{visible}" title="&#x4E3A;&#x89D2;&#x8272;&#x8BBE;&#x7F6E;&#x6743;&#x9650;" onok="{onOk}" oncancel="{onCancel}" destroyonclose="">
                <tree checkable="" defaultexpandall="" oncheck="{onCheck}" checkedkeys="{checkedKeys}">
                    <treenode title="&#x6240;&#x6709;&#x6743;&#x9650;" key="{0}" disabled>
                        {this.renderResources(resources)}
                    </treenode>
                </tree>
            </modal>
        )

    }
}

@Form.create()
class EditModal extends Component{
    render() {
        let {visible,onOk,isCreate,onCancel,record,form: {getFieldDecorator}}=this.props;
        let {name,email,id}=record;
        return (
            <modal title="{isCreate?&apos;&#x521B;&#x5EFA;&apos;:&apos;&#x4FEE;&#x6539;&apos;}" visible="{visible}" onok="{onOk}" oncancel="{onCancel}" destroyonclose="">
                <form></form>
                    <formitem>
                       {
                            getFieldDecorator(&apos;id&apos;,{
                                initialValue: id
                            })(<input type="hidden">)
                        }
                    </formitem>
                    <formitem label="&#x89D2;&#x8272;&#x540D;&#x79F0;">
                        {
                            getFieldDecorator(&apos;name&apos;,{
                                rules: [{
                                    required: true,
                                    message:&apos;&#x89D2;&#x8272;&#x540D;&#x79F0;&#x5FC5;&#x987B;&#x8F93;&#x5165;&apos;
                                }],
                                initialValue: name
                            })(<input>)
                        }
                    </formitem>
                
            </modal>
        )
    }
}

</treenode></permissonmodal></editmodal><table columns="{columns}" datasource="{list}" loading="{loading}" rowkey="{record" ==""></table></card></fragment></code></pre>
<h3 id="t4012.2 models/role.js">12.2 models/role.js <a href="#t4012.2 models/role.js"> # </a></h3>
<p>src/pages/admin/role/models/role.js</p>
<pre><code class="lang-js">import * as service from &apos;../services/role&apos;;
const ENTITY=&apos;role&apos;;
export default {
    namespace: ENTITY,
    state: {
        list: [],
        isCreate:true,
        editVisible: false,
        page:1,
        record: {},
        selectedRowKeys: [],
        selectedRows: [],
        checkedKeys: [],
        resources:[],
        setPermissionVisible:false,
        where: {}
    },
    reducers: {
        save(state,{payload}) {
            return {...state,...payload};
        }
    },
    effects: {
        *fetch({payload: {page,where}},{call,put,select}) {
            if (!where) {
                where =yield select(state =&gt; state[ENTITY].where);
            }
            if (!page) {
                page =yield select(state =&gt; state[ENTITY].page);
            }
            const {list,total}=yield call(service.fetch,page,where);
            yield put({type:&apos;save&apos;,payload:{page,where,list,page:parseInt(page),total}});
        },
        *search({payload:where},{call,put}) {
            yield put({type: &apos;fetch&apos;,payload: {page:1,where}});
        },
        *create({payload},{call,put}) {
            yield call(service.create,payload);
            yield put({type: &apos;fetch&apos;,payload: {page:1}});
            yield put({type:&apos;save&apos;,payload:{editVisible:false}});
        },
        *update({payload},{call,put,select}) {
            yield call(service.update,payload);
            let page=yield select(state=&gt;state[ENTITY].page);
            yield put({type: &apos;fetch&apos;,payload: {page}});
            yield put({type:&apos;save&apos;,payload:{editVisible:false}});
        },
        *del({payload},{call,put}) {
            yield call(service.del,payload);
            yield put({type: &apos;fetch&apos;,payload: {page:1}});
        },
        *delAll({payload},{call,put}) {
            yield call(service.delAll,payload);
            yield put({type: &apos;fetch&apos;,payload: {page:1}});
        },
        *getResource({payload},{call,put}) {
            const resources=yield call(service.getResources);
            yield put({type:&apos;save&apos;,payload:{resources}});
        },
        *setRolePermission({payload},{call,put,select}) {
            let {record,checkedKeys}=yield select(state =&gt; state[ENTITY]);
            yield call(service.setRolePermission,{roleId:record.id,resourceIds:checkedKeys});
            yield put({type: &apos;fetch&apos;,payload: {}});
            yield put({type:&apos;save&apos;,payload:{setPermissionVisible:false,selectedRowKeys:[],selectedRows:[]}});
        }
    },
    subscriptions: {
        setup({dispatch,history}) {
            return history.listen(({pathname,query}) =&gt; {
                if (pathname === `/admin/${ENTITY}`) {
                    dispatch({type: &apos;fetch&apos;,payload: query});
                    dispatch({type:&apos;getResource&apos;});
                }
            });
        }
    }
}
</code></pre>
<h3 id="t4112.3 services/role.js">12.3 services/role.js <a href="#t4112.3 services/role.js"> # </a></h3>
<p>src/pages/admin/role/services/role.js</p>
<pre><code class="lang-js">export function getResources() {
    return request(`/api/${ENTITY}/getResources`);
}
export function setRolePermission(values) {
    return request(`/api/${ENTITY}/setRolePermission`,{
        method: &apos;POST&apos;,
        headers:{&quot;Content-Type&quot;:&quot;application/json&quot;},
        body:JSON.stringify(values)
    });
}
</code></pre>
<h2 id="t4213.&#x7ED9;&#x89D2;&#x8272;&#x52A0;&#x7528;&#x6237;">13.&#x7ED9;&#x89D2;&#x8272;&#x52A0;&#x7528;&#x6237; <a href="#t4213.&#x7ED9;&#x89D2;&#x8272;&#x52A0;&#x7528;&#x6237;"> # </a></h2>
<h3 id="t4313.1 roles/page.js">13.1 roles/page.js <a href="#t4313.1 roles/page.js"> # </a></h3>
<p>src/pages/admin/roles/page.js</p>
<pre><code class="lang-js">import React, { Component, Fragment } from &apos;react&apos;;
import { Transfer, Icon, Tree, Card, Table, Button, Modal, Form, Input, Radio, message, Popconfirm, Select } from &apos;antd&apos;;
import { connect } from &apos;dva&apos;;
import { routerRedux } from &apos;dva/router&apos;;
let Option = Select.Option;
const ENTITY = &apos;role&apos;;
@connect(
    state =&gt; ({ ...state[ENTITY], loading: state.loading.models[ENTITY] })
)
export default class Base extends Component {
    save = (payload) =&gt; {
        this.props.dispatch({
            type: `${ENTITY}/save`,
            payload
        });
    }
    handleAdd = () =&gt; {
        this.save({ editVisible: true, record: { gender: 1 }, isCreate: true });
    }
    handleSave = () =&gt; {
        //values = {name:&apos;zfpx&apos;,email:&quot;email&quot;,gender:1}
        this.editForm.props.form.validateFields((err, values) =&gt; {
            if (err) {
                return message.warn(&apos;&#x4F60;&#x8F93;&#x5165;&#x7684;&#x8868;&#x5355;&#x6570;&#x636E;&#x4E0D;&#x5408;&#x6CD5;!&apos;);
            } else {
                this.props.dispatch({
                    type: this.props.isCreate ? `${ENTITY}/add` : `${ENTITY}/update`,
                    payload: values
                });
            }
        });
    }
    handleEdit = (record) =&gt; {
        this.save({
            editVisible: true,
            record,
            isCreate: false
        });
    }
    handleDel = (id) =&gt; {
        this.props.dispatch({
            type: `${ENTITY}/del`,
            payload: id
        });
    }
    handleDelAll = () =&gt; {
        this.props.dispatch({
            type: `${ENTITY}/delAll`,
            payload: this.props.selectedRowKeys
        });
    }
    handleSearch = () =&gt; {
        let values = this.searchForm.props.form.getFieldsValue();
        console.log(&apos;values&apos;, values);
        let where = Object.entries(values).reduce((memo, [key, val]) =&gt; {
            if (typeof val == &apos;undefined&apos;) {
                memo[key] = val;
            }
            return memo;
        }, {});
        this.props.dispatch({
            type: `${ENTITY}/fetch`,
            payload: { where }
        });
    }
    //&#x5F00;&#x59CB;&#x7ED9;&#x89D2;&#x8272;&#x5206;&#x914D;&#x6743;&#x9650;
    setResource = () =&gt; {
        let selectedRows = this.props.selectedRows;
        if (selectedRows.length == 1) {
            let record = selectedRows[0];
            this.save({ setResourceVisible: true, record, checkedKeys: record.resourceIds });
        } else {
            message.warn(&apos;&#x8BF7;&#x9009;&#x4E2D;&#x5E76;&#x4E14;&#x53EA;&#x80FD;&#x9009;&#x4E2D;&#x4E00;&#x4E2A;&#x89D2;&#x8272;!&apos;);
        }
    }
    setResourceOk = () =&gt; {
        this.props.dispatch({
            type: `${ENTITY}/setResource`
        });
    }
    onSetResourceCheck = (checkedKeys) =&gt; {
        this.save({ checkedKeys });
    }

    //&#x5F00;&#x59CB;&#x7ED9;&#x89D2;&#x8272;&#x5206;&#x914D;&#x7528;&#x6237;
    setUser = () =&gt; {
        let selectedRows = this.props.selectedRows;
        if (selectedRows.length == 1) {
            let record = selectedRows[0];
            this.save({ setUserVisible: true, record, targetKeys: record.userIds });
        } else {
            message.warn(&apos;&#x8BF7;&#x9009;&#x4E2D;&#x5E76;&#x4E14;&#x53EA;&#x80FD;&#x9009;&#x4E2D;&#x4E00;&#x4E2A;&#x89D2;&#x8272;!&apos;);
        }
    }
    setUserOk = () =&gt; {
        this.props.dispatch({
            type: `${ENTITY}/setUser`
        });
    }
    onSetUserChange = (targetKeys) =&gt; {
        this.save({ targetKeys });
    }
    render() {
        let columns = [
            {
                title: &apos;&#x59D3;&#x540D;&apos;,
                dataIndex: &apos;name&apos;,
            },
            {
                title: &apos;&#x90AE;&#x7BB1;&apos;,
                dataIndex: &apos;email&apos;,
            },
            {
                title: &apos;&#x6027;&#x522B;&apos;,
                dataIndex: &apos;gender&apos;,
                render: (val, record) =&gt; (val === 1 ? &apos;&#x7537;&apos; : &apos;&#x5973;&apos;)
            },
            {
                title: &apos;&#x64CD;&#x4F5C;&apos;,
                render: (val, record) =&gt; {
                    return (
                        <button.group>
                            <button type="warning" icon="edit" onclick="{()" ==""> this.handleEdit(record)}&gt;&#x7F16;&#x8F91;</button>
                            <popconfirm title="&#x4F60;&#x786E;&#x5B9A;&#x8981;&#x5220;&#x9664;&#x5417;?" oktext="&#x662F;" canceltext="&#x5426;" onconfirm="{()" ==""> this.handleDel(record.id)}&gt;
                                <button type="danger" icon="delete">&#x5220;&#x9664;</button>
                            </popconfirm>
                        </button.group>
                    )
                }
            }
        ]
        let { list, editVisible, record, isCreate, selectedRowKeys,
            pageNum, total, loading,
            setResourceVisible, checkedKeys, resources, setUserVisible, targetKeys, users
        } = this.props;
        let rowSelection = {
            type: &apos;checkbox&apos;,
            selectedRowKeys,
            onChange: (selectedRowKeys, selectedRows) =&gt; {
                this.save({ selectedRowKeys, selectedRows });
            }
        }
        let pagination = {
            current: pageNum,//&#x5F53;&#x524D;&#x9875;&#x7801;
            pageSize: 3,
            total,//&#x603B;&#x6761;&#x6570;
            showQuickJumper: true,
            showTotal: (total) =&gt; `&#x5171;${total}&#x6761;`,
            onChange: (pageNum, pageSize) =&gt; {
                //&#x8DF3;&#x8F6C;&#x8DEF;&#x5F84;&#x6709;&#x4E09;&#x79CD;&#x65B9;&#x6CD5;
                this.props.dispatch(routerRedux.push(`/admin/${ENTITY}?pageNum=${pageNum}`));
            }
        }
        return (
            <fragment>
                <card>
                    <searchform wrappedcomponentref="{inst" ==""> this.searchForm = inst}
                        handleSearch={this.handleSearch} /&gt;
                </searchform></card>
                <card>
                    <button type="primary" icon="plus-circle" onclick="{this.handleAdd}">&#x6DFB;&#x52A0;</button>
                    <button 8="" style="{{" marginleft:="" }}="" type="dashed" icon="delete" onclick="{this.handleDelAll}">&#x6279;&#x91CF;&#x5220;&#x9664;</button>
                    <button 8="" style="{{" marginleft:="" }}="" type="primary" icon="plus-circle" onclick="{this.setResource}">&#x5206;&#x914D;&#x6743;&#x9650;</button>
                    <button 8="" style="{{" marginleft:="" }}="" type="primary" icon="plus-circle" onclick="{this.setUser}">&#x5206;&#x914D;&#x7528;&#x6237;</button>
                     record.id}
                        rowSelection={rowSelection}
                        pagination={pagination}
                        onRow={record =&gt; ({
                            onClick: () =&gt; {
                                let index = selectedRowKeys.indexOf(record.id);
                                if (index == -1) {
                                    selectedRowKeys = [...selectedRowKeys, record.id];
                                } else {
                                    selectedRowKeys = selectedRowKeys.filter(key =&gt; key != record.id);
                                }
                                this.save({ selectedRowKeys });
                            }
                        })}
                    /&gt;
                    <editmodal wrappedcomponentref="{inst" ==""> this.editForm = inst}
                        visible={editVisible}
                        isCreate={isCreate}
                        record={record}
                        onOk={this.handleSave}
                        onCancel={() =&gt; this.save({ editVisible: false })}
                    /&gt;
                    <setresourcemodal visible="{setResourceVisible}" record="{record}" onok="{this.setResourceOk}" checkedkeys="{checkedKeys}" oncheck="{this.onSetResourceCheck}" resources="{resources}" oncancel="{()" ==""> this.save({ setResourceVisible: false })}
                    /&gt;
                    <setusermodal visible="{setUserVisible}" record="{record}" onok="{this.setUserOk}" targetkeys="{targetKeys}" onchange="{this.onSetUserChange}" users="{users}" oncancel="{()" ==""> this.save({ setUserVisible: false })}
                    /&gt;
                
            
        )
    }
}

class SetUserModal extends Component {
    render() {
        let { visible, onOk, onCancel, record, targetKeys, onChange, users } = this.props;
        return (
            <modal title="{`&#x4E3A;" ${record.name}="" 分配用户`}="" visible="{visible}" onok="{onOk}" oktext="{&quot;&#x786E;&#x5B9A;&quot;}" canceltext="{&quot;&#x53D6;&#x6D88;&quot;}" oncancel="{onCancel}" destroyonclose="">
                <transfer datasource="{users}" targetkeys="{targetKeys}" titles="{[&quot;&#x5F85;&#x9009;&#x7528;&#x6237;&quot;," "已选用户"]}="" onchange="{onChange}" render="{row" ==""> row.name}
                    rowKey={row =&gt; row.id}
                /&gt;
            </transfer></modal>
        )
    }
}


class SetResourceModal extends Component {
    renderTree = (children = []) =&gt; {
        return children.map(item =&gt; {
            if (item.children &amp;&amp; item.children.length &gt; 0) {
                return (
                    <tree.treenode title="{&lt;span"><icon type="{item.type}">{item.name}} key={item.id} &gt;
                        {this.renderTree(item.children)}
                    </icon></tree.treenode>
                )
            } else {
                return <tree.treenode title="{&lt;span"><icon type="{item.type}">{item.name}} key={item.id} /&gt;
            }
        });
    }
    render() {
        let { visible, onOk, onCancel, record, checkedKeys, onCheck, resources } = this.props;

        return (
            <modal title="&#x4E3A;&#x89D2;&#x8272;&#x5206;&#x6743;&#x9650;" visible="{visible}" onok="{onOk}" oktext="{&quot;&#x786E;&#x5B9A;&quot;}" canceltext="{&quot;&#x53D6;&#x6D88;&quot;}" oncancel="{onCancel}" destroyonclose="">
                <tree checkable="" defaultexpandall="" checkedkeys="{checkedKeys}" destroyonclose="" oncheck="{onCheck}">
                    <tree.treenode title="&#x5E73;&#x53F0;&#x6743;&#x9650;" key="{0}" disabled>
                        {this.renderTree(resources)}
                    </tree.treenode>
                </tree>
            </modal>
        )
    }
}

@Form.create()
class SearchForm extends Component {
    render() {
        let { form: { getFieldDecorator }, handleSearch } = this.props;
        return (
            <form layout="inline"></form>
                <form.item>
                    {
                        getFieldDecorator(&apos;name&apos;, {})(<input placeholder="&#x7528;&#x6237;&#x540D;">)
                    }
                </form.item>
                <form.item>
                    {
                        getFieldDecorator(&apos;email&apos;, {})(<input placeholder="&#x90AE;&#x7BB1;">)
                    }
                </form.item>
                <form.item>
                    {
                        getFieldDecorator(&apos;gender&apos;, {})(<select onselect="{handleSearch}">
                            <option value="{1}">&#x7537;</option>
                            <option value="{0}">&#x5973;</option>
                        </select>)
                    }

                </form.item>
                <form.item>
                    <button onclick="{handleSearch}" icon="search" shape="circle"></button>
                </form.item>
            
        )
    }
}

//&#x4E00;&#x65E6;&#x7528;Form.create()&#x7684;&#x7ED3;&#x679C;&#x8FDB;&#x884C;&#x88C5;&#x9970;&#x4E86;&#xFF0C;&#x90A3;&#x4E48;&#x6B64;&#x7EC4;&#x4EF6;&#x5C31;&#x4F1A;&#x83B7;&#x53D6;&#x4E00;&#x4E2A;props.form&#x7684;&#x5C5E;&#x6027;.form&#x6709;&#x5F88;&#x591A;&#x4E2A;&#x65B9;&#x6CD5;
@Form.create()
class EditModal extends Component {
    render() {
        let { visible, form: { getFieldDecorator }, onOk, onCancel, record, isCreate } = this.props;
        let formItemLayout = {
            labelCol: {
                xs: { span: 24 },
                sm: { span: 6 },
            },
            wrapperCol: {
                xs: { span: 24 },
                sm: { span: 18 },
            },
        }
        return (
            <modal title="{isCreate" ?="" "新增用户"="" :="" "编辑用户"}="" visible="{visible}" onok="{onOk}" oktext="{&quot;&#x786E;&#x5B9A;&quot;}" canceltext="{&quot;&#x53D6;&#x6D88;&quot;}" oncancel="{onCancel}" destroyonclose="">
                <form></form>
                    <form.item>
                        {
                            getFieldDecorator(&apos;id&apos;, {
                                initialValue: record.id
                            })(<input type="hidden">)
                        }
                    </form.item>
                    <form.item label="&#x7528;&#x6237;&#x540D;" {...formitemlayout}="">
                        {
                            getFieldDecorator(&apos;name&apos;, {
                                initialValue: record.name,
                                rules: [
                                    { required: true, message: &apos;&#x8BF7;&#x8F93;&#x5165;&#x7528;&#x6237;&#x540D;&apos; }
                                ]
                            })(<input placeholder="&#x7528;&#x6237;&#x540D;">)
                        }
                    </form.item>
                    <form.item label="&#x90AE;&#x7BB1;" {...formitemlayout}="">
                        {
                            getFieldDecorator(&apos;email&apos;, {
                                initialValue: record.email,
                                rules: [
                                    { type: &apos;email&apos;, message: &apos;&#x8BF7;&#x8F93;&#x5165;&#x5408;&#x6CD5;&#x7684;&#x90AE;&#x7BB1;&#x5730;&#x5740;!&apos; },
                                    { required: true, message: &apos;&#x8BF7;&#x8F93;&#x5165;&#x90AE;&#x7BB1;!&apos; }
                                ]
                            })(<input placeholder="&#x90AE;&#x7BB1;">)
                        }
                    </form.item>
                    <form.item label="&#x6027;&#x522B;" {...formitemlayout}="">
                        {
                            getFieldDecorator(&apos;gender&apos;, {
                                initialValue: record.gender,
                                rules: [
                                    { required: true, message: &apos;&#x8BF7;&#x9009;&#x62E9;&#x6027;&#x522B;&apos; }
                                ]
                            })(
                                <radio.group>
                                    <radio value="{1}">&#x7537;</radio>
                                    <radio value="{0}">&#x5973;</radio>
                                </radio.group>
                            )
                        }
                    </form.item>
                
            </modal>
        )
    }
}
</icon></tree.treenode></setusermodal></setresourcemodal></editmodal><table columns="{columns}" datasource="{list}" loading="{loading}" rowkey="{record" ==""></table></card></fragment></code></pre>
<h3 id="t4413.2 models/roles.js">13.2 models/roles.js <a href="#t4413.2 models/roles.js"> # </a></h3>
<p>src/pages/admin/roles/models/roles.js</p>
<pre><code class="lang-js">import * as service from &apos;../services/role&apos;;
import { PAGE_SIZE } from &apos;../constants&apos;;
const ENTITY = &apos;role&apos;;
export default {

    namespace: ENTITY,

    state: {
        isCreate: true,
        list: [],
        pageNum: 1,
        total: 0,
        where: {},
        editVisible: false,//&#x662F;&#x5426;&#x663E;&#x793A;&#x7F16;&#x8F91;&#x7A97;&#x53E3;
        record: { gender: 1 },//&#x4EE3;&#x8868;&#x5F53;&#x524D;&#x6B63;&#x5728;&#x7F16;&#x8F91;&#x7684;&#x5BF9;&#x8C61;
        selectedRowKeys: [],
        selectedRows: [],
        setResourceVisible: false,//&#x8BBE;&#x7F6E;&#x6743;&#x9650;&#x7684;&#x6A21;&#x6001;&#x7A97;&#x53E3;&#x662F;&#x5426;&#x663E;&#x793A;
        checkedKeys: [],//&#x54EA;&#x4E9B;&#x6743;&#x9650;&#x88AB;&#x9009;&#x4E2D;&#x4E86;
        resources: [],//&#x8D44;&#x6E90;,&#x662F;&#x4E00;&#x4E2A;&#x6570;&#x7EC4;&#xFF0C;&#x91CC;&#x9762;&#x7B2C;&#x4E00;&#x5C42;&#x653E;&#x7740;&#x9876;&#x5C42;&#x8D44;&#x6E90;
        setUserVisible: false,//&#x7A97;&#x53E3;&#x662F;&#x5426;&#x663E;&#x793A;
        targetKeys: [],//&#x9009;&#x4E2D;&#x7684;&#x7528;&#x6237;
        users: [] //&#x6240;&#x6709;&#x7684;&#x7528;&#x6237;
    },

    subscriptions: {
        setup({ dispatch, history }) {
            // &#x901A;&#x8FC7;&#x5730;&#x5740;&#x6765;&#x5206;&#x9875;   /admin/user?pageNum=2
            history.listen(({ pathname, query }) =&gt; {
                if (pathname === `/admin/${ENTITY}`) {
                    dispatch({ type: &apos;fetch&apos;, payload: query });
                    dispatch({ type: &apos;getResource&apos; });
                    dispatch({ type: &apos;getUser&apos; });
                }
            });
        },
    },

    effects: {
        *fetch({ payload: { pageNum, where } }, { call, put, select }) {
            if (!pageNum) {
                pageNum = yield select(state =&gt; state[ENTITY].pageNum);
            }
            if (!where) {
                where = yield select(state =&gt; state[ENTITY].where);
            }
            let { list, total } = yield call(service.list, pageNum, PAGE_SIZE, where);
            yield put({ type: &apos;save&apos;, payload: { list, total, pageNum: parseInt(pageNum), where } });
        },
        *add({ payload }, { call, put }) {
            yield call(service.add, payload);
            yield put({ type: &apos;fetch&apos;, payload: {} });
            yield put({ type: &apos;save&apos;, payload: { editVisible: false } });
        },
        *update({ payload }, { call, put }) {
            yield call(service.update, payload);
            yield put({ type: &apos;fetch&apos;, payload: {} });
            yield put({ type: &apos;save&apos;, payload: { editVisible: false } });
        },
        *del({ payload }, { call, put }) {
            yield call(service.del, payload);
            yield put({ type: &apos;fetch&apos;, payload: {} });
        },
        *delAll({ payload }, { call, put }) {
            yield call(service.delAll, payload);
            yield put({ type: &apos;fetch&apos;, payload: {} });
        },
        *getResource({ }, { call, put }) {
            let resources = yield call(service.getResource);
            yield put({ type: &apos;save&apos;, payload: { resources } });
        },
        *getUser({ }, { call, put }) {
            let users = yield call(service.getUser);
            yield put({ type: &apos;save&apos;, payload: { users } });
        },
        *setResource({ }, { call, put, select }) {
            let record = yield select(state =&gt; state.role.record);
            let checkedKeys = yield select(state =&gt; state.role.checkedKeys);
            yield call(service.setResource, {
                roleId: record.id,
                resourceIds: checkedKeys
            });
            yield put({ type: &apos;save&apos;, payload: { setResourceVisible: false, selectedRowKeys: [], selectedRows: [] } });
            yield put({ type: &apos;fetch&apos;, payload: {} });
        },
        *setUser({ }, { call, put, select }) {
            let record = yield select(state =&gt; state.role.record);
            let targetKeys = yield select(state =&gt; state.role.targetKeys);
            yield call(service.setUser, {
                roleId: record.id,
                userIds: targetKeys
            });
            yield put({ type: &apos;save&apos;, payload: { setUserVisible: false, selectedRowKeys: [], selectedRows: [] } });
            yield put({ type: &apos;fetch&apos;, payload: {} });
        }
    },

    reducers: {
        save(state, action) {
            return { ...state, ...action.payload };
        }
    },

};

</code></pre>
<h3 id="t4513.3 services/roles.js">13.3 services/roles.js <a href="#t4513.3 services/roles.js"> # </a></h3>
<p>src/pages/admin/roles/services/roles.js</p>
<pre><code class="lang-js">import request from &apos;@/utils/request&apos;;
import querystring from &apos;querystring&apos;;
const ENTITY = &apos;role&apos;;
export function list(pageNum, pageSize, where) {
    let wherestring = querystring.stringify(where);
    return request(`/api/${ENTITY}?pageNum=${pageNum}&amp;pageSize=${pageSize}&amp;${wherestring}`);
}
export function getResource() {
    return request(`/api/${ENTITY}/getResource`);
}
export function getUser() {
    return request(`/api/${ENTITY}/getUser`);
}

export function add(values) {
    return request(`/api/${ENTITY}`, {
        method: &apos;POST&apos;,
        headers: {
            &quot;Content-Type&quot;: &quot;application/json&quot;
        },
        body: JSON.stringify(values)
    });
}
export function setResource(values) {
    return request(`/api/${ENTITY}/setResource`, {
        method: &apos;POST&apos;,
        headers: {
            &quot;Content-Type&quot;: &quot;application/json&quot;
        },
        body: JSON.stringify(values)
    });
}
export function setUser(values) {
    return request(`/api/${ENTITY}/setUser`, {
        method: &apos;POST&apos;,
        headers: {
            &quot;Content-Type&quot;: &quot;application/json&quot;
        },
        body: JSON.stringify(values)
    });
}
export function update(values) {
    return request(`/api/${ENTITY}/${values.id}`, {
        method: &apos;PUT&apos;,
        headers: {
            &quot;Content-Type&quot;: &quot;application/json&quot;
        },
        body: JSON.stringify(values)
    });
}

export function del(id) {
    return request(`/api/${ENTITY}/${id}`, {
        method: &apos;DELETE&apos;
    });
}

export function delAll(ids) {
    return request(`/api/${ENTITY}/${ids[0]}`, {
        method: &apos;DELETE&apos;,
        headers: {
            &quot;Content-Type&quot;: &quot;application/json&quot;
        },
        body: JSON.stringify(ids)
    });
}
</code></pre>

        <div class="copyright">Powered by <a href="https://github.com/jaywcjlove/idoc" target="_blank">idoc</a>. Dependence <a href="https://nodejs.org">Node.js</a> run.</div>
    