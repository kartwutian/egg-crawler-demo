
        <h2 id="t01. &#x751F;&#x6210;&#x9879;&#x76EE;">1. &#x751F;&#x6210;&#x9879;&#x76EE; <a href="#t01. &#x751F;&#x6210;&#x9879;&#x76EE;"> # </a></h2>
<pre><code class="lang-js">$ npm install dva-cli -g
$ dva -v
$ dva new zhufeng-dva-chat
</code></pre>
<h2 id="t12. &#x5B9E;&#x73B0;&#x6CE8;&#x518C;&#x548C;&#x767B;&#x5F55;">2. &#x5B9E;&#x73B0;&#x6CE8;&#x518C;&#x548C;&#x767B;&#x5F55; <a href="#t12. &#x5B9E;&#x73B0;&#x6CE8;&#x518C;&#x548C;&#x767B;&#x5F55;"> # </a></h2>
<h3 id="t22.1 User/_layout.js">2.1 User/_layout.js <a href="#t22.1 User/_layout.js"> # </a></h3>
<p>src/pages/User/_layout.js</p>
<pre><code class="lang-js">import React,{Component} from &apos;react&apos;;
import styles from &apos;./User.less&apos;;
export default class UserLayout extends Component {
    render() {
        return (
            <div classname="{styles.container}">
                {this.props.children}
            </div>
        )
    }
}
</code></pre>
<h3 id="t32.2 User/User.less">2.2 User/User.less <a href="#t32.2 User/User.less"> # </a></h3>
<p>src/pages/User/User.less</p>
<pre><code class="lang-less">.container{
    display: flex;
    height:100%;
    justify-content: center;
    align-items: center;
}
</code></pre>
<h3 id="t42.3 User/Register.js">2.3 User/Register.js <a href="#t42.3 User/Register.js"> # </a></h3>
<p>src/pages/User/Register.js</p>
<pre><code class="lang-js">import React,{Component} from &apos;react&apos;;
import {connect} from &apos;dva&apos;;
import Link from &apos;umi/link&apos;;
import { Form, Input, Button, Select, Row, Col, Popover, Progress } from &apos;antd&apos;;
import styles from &apos;./Register.less&apos;;
const FormItem = Form.Item;
const { Option } = Select;
const InputGroup=Input.Group;

const passwordStatusMap = {
    ok: (
      <div classname="{styles.success}">
        &#x5F3A;&#x5EA6;: &#x5F3A;
      </div>
    ),
    pass: (
      <div classname="{styles.warning}">
        v&#x5F3A;&#x5EA6;: &#x4E2D;
      </div>
    ),
    poor: (
      <div classname="{styles.error}">
        &#x5F3A;&#x5EA6;: &#x592A;&#x77ED;
      </div>
    ),
};
const passwordProgressMap = {
    ok: &apos;success&apos;,
    pass: &apos;normal&apos;,
    poor: &apos;exception&apos;,
  };


@connect(({ register, loading }) =&gt; ({
    register,
    submitting: loading.effects[&apos;register/submit&apos;],
  }))
@Form.create()
export default class extends Component {
    state = {
        count: 0,
        confirmDirty: false,
        visible: false,
        help: &apos;&apos;,
        prefix: &apos;86&apos;,
    };
    getPasswordStatus=() =&gt; {
        const { form } = this.props;
        const value = form.getFieldValue(&apos;password&apos;);
        if (value &amp;&amp; value.length &gt; 9) {
            return &apos;ok&apos;;
        }
        if (value &amp;&amp; value.length &gt; 5) {
            return &apos;pass&apos;;
        }
        return &apos;poor&apos;;
    };

    renderPasswordProgress = () =&gt; {
        const { form } = this.props;
        const value = form.getFieldValue(&apos;password&apos;);
        const passwordStatus = this.getPasswordStatus();
        return value &amp;&amp; value.length ? (
          <div classname="{styles[`progress-${passwordStatus}`]}">
            <progress 10="" status="{passwordProgressMap[passwordStatus]}" classname="{styles.progress}" strokewidth="{6}" percent="{value.length" *=""> 100 ? 100 : value.length * 10}
              showInfo={false}
            /&gt;
          </progress></div>
        ) : null;
      };

      checkPassword = (rule, value, callback) =&gt; {
        const { visible, confirmDirty } = this.state;
        if (!value) {
          this.setState({
            help:&quot;&#x8BF7;&#x8F93;&#x5165;&#x5BC6;&#x7801;!&quot;,
            visible: !!value,
          });
          callback(&apos;error&apos;);
        } else {
          this.setState({
            help: &apos;&apos;,
          });
          if (!visible) {
            this.setState({
              visible: !!value,
            });
          }
          if (value.length &lt; 6) {
            callback(&apos;error&apos;);
          } else {
            const { form } = this.props;
            if (value &amp;&amp; confirmDirty) {
              form.validateFields([&apos;confirm&apos;], { force: true });
            }
            callback();
          }
        }
      };
    checkConfirm = (rule, value, callback) =&gt; {
        const { form } = this.props;
        if (value &amp;&amp; value !== form.getFieldValue(&apos;password&apos;)) {
          callback(&apos;&#x4E24;&#x6B21;&#x8F93;&#x5165;&#x7684;&#x5BC6;&#x7801;&#x4E0D;&#x5339;&#x914D;!&apos;);
        } else {
          callback();
        }
    };
    changePrefix = value =&gt; {
        this.setState({
          prefix: value,
        });
    };
    onGetCaptcha = () =&gt; {
        let count = 59;
        this.setState({ count });
        this.interval = setInterval(() =&gt; {
          count -= 1;
          this.setState({ count });
          if (count === 0) {
            clearInterval(this.interval);
          }
        }, 1000);
      };
    render() {
        const { form, submitting } = this.props;
        const {getFieldDecorator}=form;
        const { count, prefix, help, visible } = this.state;
        return (
            <div classname="{styles.register}">
                <h3>&#x7528;&#x6237;&#x6CE8;&#x518C;</h3>
                <form onsubmit="{this.handleSubmit}">
                    <formitem>
                        {getFieldDecorator(&apos;mail&apos;, {
                            rules: [
                                {
                                required: true,
                                message:  &apos;&#x90AE;&#x7BB1;&#x5FC5;&#x987B;&#x8F93;&#x5165;&apos;,
                                },
                                {
                                type: &apos;email&apos;,
                                message: &apos;&#x90AE;&#x7BB1;&#x683C;&#x5F0F;&#x4E0D;&#x5408;&#x6CD5;&apos;,
                                },
                            ],
                        })(
                        <input size="large" placeholder="&#x90AE;&#x7BB1;">
                        )}
                    </formitem>
                    <formitem help="{help}">
                        <popover content="{" <div="" style="{{" padding:="" '4px="" 0'="" }}="">
                                {passwordStatusMap[this.getPasswordStatus()]}
                                {this.renderPasswordProgress()}
                                <div 10="" style="{{" margintop:="" }}="">
                                  &#x8BF7;&#x81F3;&#x5C11;&#x8F93;&#x5165; 6 &#x4E2A;&#x5B57;&#x7B26;&#x3002;&#x8BF7;&#x4E0D;&#x8981;&#x4F7F;&#x7528;&#x5BB9;&#x6613;&#x88AB;&#x731C;&#x5230;&#x7684;&#x5BC6;&#x7801;&#x3002;
                                </div>
                            </popover></formitem></form></div>
                        }
                        overlayStyle={{ width: 240 }}
                        placement=&quot;right&quot;
                        visible={visible}
                        &gt;
                        {getFieldDecorator(&apos;password&apos;, {
                            rules: [
                            {
                                validator: this.checkPassword,
                            },
                            ],
                        })(
                            <input size="large" type="password" placeholder="&#x81F3;&#x5C11;&#x516D;&#x4F4D;&#x5BC6;&#x7801;&#xFF0C;&#x533A;&#x5206;&#x5927;&#x5C0F;&#x5199;">
                        )}
                        
                    
                <formitem>
                    {getFieldDecorator(&apos;confirm&apos;, {
                    rules: [
                        {
                         required: true,
                         message: &apos;&#x8BF7;&#x8F93;&#x5165;&#x786E;&#x8BA4;&#x5BC6;&#x7801;&#xFF01;&apos;,
                        },
                        {
                         validator: this.checkConfirm,
                        },
                    ],
                    })(
                    <input size="large" type="password" placeholder="&#x786E;&#x8BA4;&#x5BC6;&#x7801;">
                    )}
                </formitem>
                <formitem>
                    <inputgroup compact="">
                    <select size="large" value="{prefix}" onchange="{this.changePrefix}" style="{{" width:="" '20%'="" }}="">
                        <option value="86">+86</option>
                        <option value="87">+87</option>
                    </select>
                    {getFieldDecorator(&apos;mobile&apos;, {
                        rules: [
                        {
                            required: true,
                            message: &apos;&#x8BF7;&#x8F93;&#x5165;&#x624B;&#x673A;&#x53F7;!&apos;,
                        },
                        {
                            pattern: /^\d{11}$/,
                            message: &apos;&#x624B;&#x673A;&#x53F7;&#x683C;&#x5F0F;&#x9519;&#x8BEF;&#xFF01;&apos;,
                        },
                        ],
                    })(
                        <input size="large" style="{{" width:="" '80%'="" }}="" placeholder="&#x624B;&#x673A;&#x53F7;">
                    )}
                    </inputgroup>
                </formitem>
                <formitem>
                    <row gutter="{8}">
                        
                            {getFieldDecorator(&apos;captcha&apos;, {
                            rules: [
                                {
                                required: true,
                                message: &apos;&#x8BF7;&#x8F93;&#x5165;&#x9A8C;&#x8BC1;&#x7801;&#xFF01;&apos;,
                                },
                            ],
                            })(
                            <input size="large" placeholder="&#x9A8C;&#x8BC1;&#x7801;">
                            )}
                        
                        
                            <button size="large" disabled="{count}" classname="{styles.getCaptcha}" onclick="{this.onGetCaptcha}">
                              {count? `${count} s`: &apos;&#x83B7;&#x53D6;&#x9A8C;&#x8BC1;&#x7801;&apos;}
                            </button>
                        
                    </row>
                </formitem>
                <formitem>
                    <button size="large" loading="{submitting}" classname="{styles.submit}" type="primary" htmltype="submit">
                    &#x6CE8;&#x518C;
                    </button>
                    <link classname="{styles.login}" to="/User/Login">
                      &#x4F7F;&#x7528;&#x5DF2;&#x6709;&#x8D26;&#x6237;&#x767B;&#x5F55;
                    
                </formitem>
              
            

        );
    }
}
</code></pre>
<h3 id="t52.4  User/Register.less">2.4  User/Register.less <a href="#t52.4  User/Register.less"> # </a></h3>
<p>src/pages/User/Register.less</p>
<pre><code class="lang-less">.register{
    width:450px;
    border:1px solid #CCC;
    border-radius: 10px;
    padding:20px;
    h3{
        text-align: center;
    }
    .getCaptcha{
        width:100%;
        display:block;
    }
    .login{
        float:right;
    }
}
</code></pre>
<h2 id="t63. &#x5B9E;&#x73B0;&#x624B;&#x673A;&#x9A8C;&#x8BC1;&#x7801;&#x9A8C;&#x8BC1;">3. &#x5B9E;&#x73B0;&#x624B;&#x673A;&#x9A8C;&#x8BC1;&#x7801;&#x9A8C;&#x8BC1; <a href="#t63. &#x5B9E;&#x73B0;&#x624B;&#x673A;&#x9A8C;&#x8BC1;&#x7801;&#x9A8C;&#x8BC1;"> # </a></h2>
<h3 id="t73.1 request.js">3.1 request.js <a href="#t73.1 request.js"> # </a></h3>
<pre><code class="lang-js">import fetch from &apos;dva/fetch&apos;;

function parseJSON(response) {
  return response.json();
}

function checkStatus(response) {
  if (response.status &gt;= 200 &amp;&amp; response.status &lt; 300) {
    return response;
  }

  const error = new Error(response.statusText);
  error.response = response;
  throw error;
}

function checkSuccess(data) {
  if (data.code == 0) {
    return data;
  }

  const error = new Error(data.error);
  throw error;
}

/**
 * Requests a URL, returning a promise.
 *
 * @param  {string} url       The URL we want to request
 * @param  {object} [options] The options we want to pass to &quot;fetch&quot;
 * @return {object}           An object containing either &quot;data&quot; or &quot;err&quot;
 */
const HOST=&apos;http://localhost:3000&apos;;
export default function request(url, options) {
  return fetch(HOST+url, options)
    .then(checkStatus)
    .then(parseJSON)
    .then(checkSuccess)
    .catch(err =&gt; ({ err }));
}

</code></pre>
<h3 id="t83.2 User/Register.js">3.2 User/Register.js <a href="#t83.2 User/Register.js"> # </a></h3>
<p>src/pages/User/Register.js</p>
<pre><code class="lang-diff">-    onGetCaptcha = () =&gt; {
+    onGetCaptcha=() =&gt; {
+        const {dispatch,form}=this.props;
+        let mobile=form.getFieldValue(&apos;mobile&apos;);
+        dispatch({
+            type: &apos;register/getCaptcha&apos;,
+            payload:mobile
+        });
</code></pre>
<h3 id="t93.3 models/register.js">3.3 models/register.js <a href="#t93.3 models/register.js"> # </a></h3>
<p>src/pages/User/models/register.js</p>
<pre><code class="lang-js">import * as registerService from &apos;../services/register&apos;;
export default {
  namespace: &apos;register&apos;,
  state: {

  },
  effects: {
      *getCaptcha({payload},{call,put}) {
        const {data} = yield call(registerService.getCaptcha,payload);
        console.log(data);
    }
  },
  reducers: {}
};
</code></pre>
<h3 id="t103.4 services/register.js">3.4 services/register.js <a href="#t103.4 services/register.js"> # </a></h3>
<p>src/pages/User/services/register.js</p>
<pre><code class="lang-js">import request from &apos;../../../utils/request&apos;;
export function getCaptcha(mobile) {
  return request(`/user/getCaptcha?mobile=${mobile}`);
}
</code></pre>
<h3 id="t113.5 server/app.js">3.5 server/app.js <a href="#t113.5 server/app.js"> # </a></h3>
<p>server/app.js</p>
<pre><code class="lang-js">let express=require(&apos;express&apos;);
let session=require(&apos;express-session&apos;);
const cors=require(&apos;cors&apos;);
let app=express();
app.use(cors());
app.use(session({
    resave:true,
    secret:&apos;zfpx&apos;,
    saveUninitialized:true
}));
let user=require(&apos;./routes/user&apos;);
app.use(&apos;/user&apos;,user);
app.listen(3000);
</code></pre>
<h3 id="t123.6 routes/user.js">3.6 routes/user.js <a href="#t123.6 routes/user.js"> # </a></h3>
<p>server/routes/user.js</p>
<pre><code class="lang-js">let express=require(&apos;express&apos;);
let router=express.Router();
let axios=require(&apos;axios&apos;);
let {SMS}=require(&apos;../config&apos;);
router.get(&apos;/getCaptcha&apos;,async function (req,res) {
    let {mobile}=req.query;
    let captcha=new Date().getMilliseconds();
    req.session.captcha = captcha;
    let {data} = await axios({
        method: &apos;POST&apos;,
        url: &apos;https://open.ucpaas.com/ol/sms/sendsms&apos;,
        data: {
            ...SMS,
            mobile,
            param:captcha,
        },
        headers: {
            &quot;Content-Type&quot;: &quot;application/json;charset=utf-8&quot;,
            &quot;Accept&quot;: &quot;application/json&quot;
        }
    });
    if (data.code == &apos;000000&apos;) {
        res.json({code: 0,data:captcha});
    } else {
        res.json({code:1,error:&apos;&#x83B7;&#x53D6;&#x9A8C;&#x8BC1;&#x7801;&#x5931;&#x8D25;!&apos;});
    }
});
module.exports=router;
</code></pre>
<h3 id="t133.7 server/config.js">3.7 server/config.js <a href="#t133.7 server/config.js"> # </a></h3>
<p>server/config.js</p>
<pre><code class="lang-js">module.exports={
    SMS: {
        sid: &apos;[email&#xA0;protected]&apos;,   //&#x5F00;&#x53D1;&#x8005;&#x8D26;&#x53F7;id &#x53BB;&#x6389;@
    token: &apos;[email&#xA0;protected]&apos;, //&#x5F00;&#x53D1;&#x8005;token
    appid: &apos;[email&#xA0;protected]&apos;, //&#x5E94;&#x7528;id
        templateid: &apos;387675&apos;,                      //&#x77ED;&#x4FE1;&#x6A21;&#x677F;id
    }
}
</code></pre>
<h2 id="t144.&#x624B;&#x673A;&#x6CE8;&#x518C;&#x548C;&#x767B;&#x5F55;">4.&#x624B;&#x673A;&#x6CE8;&#x518C;&#x548C;&#x767B;&#x5F55; <a href="#t144.&#x624B;&#x673A;&#x6CE8;&#x518C;&#x548C;&#x767B;&#x5F55;"> # </a></h2>
<h3 id="t154.1 server/app.js">4.1 server/app.js <a href="#t154.1 server/app.js"> # </a></h3>
<p>server/app.js</p>
<pre><code class="lang-diff">+const bodyParser=require(&apos;body-parser&apos;);
 let app=express();
-app.use(cors());
+app.use(cors({
+    origin:&apos;http://localhost:8000&apos;,
+    credentials:true
+}));
+app.use(bodyParser.json());
</code></pre>
<h3 id="t164.2 server/config.js">4.2 server/config.js <a href="#t164.2 server/config.js"> # </a></h3>
<p>server/config.js</p>
<pre><code class="lang-diff">+    DB: {
+        url:&apos;mongodb://localhost/chat&apos;
+    }
</code></pre>
<h3 id="t174.3 models/index.js">4.3 models/index.js <a href="#t174.3 models/index.js"> # </a></h3>
<p>server/models/index.js</p>
<pre><code class="lang-js">const mongoose = require(&apos;mongoose&apos;);
const Schema = mongoose.Schema;
const ObjectId = Schema.Types.ObjectId;
const {
  DB
} = require(&apos;../config&apos;);
const conn = mongoose.createConnection(DB.url,{ useNewUrlParser: true });
const User = conn.model(&apos;User&apos;, {
    email: {type: String,required: true},
    password: {type: String,required: true},
    mobile:{type:String,required:true}
});
module.exports={
    User
}
</code></pre>
<h3 id="t184.4 routes/user.js">4.4 routes/user.js <a href="#t184.4 routes/user.js"> # </a></h3>
<p>server/routes/user.js</p>
<pre><code class="lang-js">let express=require(&apos;express&apos;);
let router=express.Router();
let axios=require(&apos;axios&apos;);
let {SMS}=require(&apos;../config&apos;);
const {User}=require(&apos;../models&apos;);
router.get(&apos;/getCaptcha&apos;,async function (req,res) {
    let {mobile}=req.query;
    let captcha=new Date().getMilliseconds();
    req.session.mobile=mobile;
    req.session.captcha=captcha;
    let {data} = await axios({
        method: &apos;POST&apos;,
        url: &apos;https://open.ucpaas.com/ol/sms/sendsms&apos;,
        data: {
            ...SMS,
            mobile,
            param:captcha,
        },
        headers: {
            &quot;Content-Type&quot;: &quot;application/json;charset=utf-8&quot;,
            &quot;Accept&quot;: &quot;application/json&quot;
        }
    });
    if (data.code == &apos;000000&apos;) {
        res.json({code: 0,data:captcha});
    } else {

        res.json({code:1,error:&apos;error&apos;});
    } 
});

router.post(&apos;/register&apos;,async function (req,res) {
    let {email,password,mobile,captcha}=req.body;
    if (req.session.captcha != captcha) {
        return res.json({code:0,error:&apos;&#x9A8C;&#x8BC1;&#x7801;&#x9519;&#x8BEF;!&apos;});
    }
    let user=new User({email,password,mobile});
    try {
        await user.save();
        res.json({code:0,data:&apos;&#x6CE8;&#x518C;&#x6210;&#x529F;&apos;});
    } catch (error) {
        res.json({code:1,error});
    }
});
router.post(&apos;/login&apos;,async function (req,res) {
    let {email,password,captcha,type}=req.body;
    if (type==&apos;mobile&apos;) {
        if (req.session.captcha != captcha) {
            return res.json({code:0,error:&apos;&#x767B;&#x5F55;&#x5931;&#x8D25;!&apos;});
        }
        let mobile=req.session.mobile;
        console.log(mobile,req.session.captcha , captcha);
        let oldUser=await User.findOne({mobile});
        if (oldUser) {
            req.session.user=oldUser;
            res.json({code:0,data:&apos;&#x767B;&#x5F55;&#x6210;&#x529F;&apos;});
        } else {
            res.json({code:1,error:&apos;&#x7528;&#x6237;&#x540D;&#x6216;&#x5BC6;&#x7801;&#x9519;&#x8BEF;&apos;});
        }
    } else {
        let oldUser=await User.findOne({email,password});
        if (oldUser) {
            req.session.user=oldUser;
            res.json({code:0,data:&apos;&#x767B;&#x5F55;&#x6210;&#x529F;&apos;});
        } else {
            res.json({code:1,error:&apos;&#x7528;&#x6237;&#x540D;&#x6216;&#x5BC6;&#x7801;&#x9519;&#x8BEF;&apos;});
        }
    }
});
module.exports=router;
</code></pre>
<h3 id="t194.5 Rooms/index.jsx">4.5 Rooms/index.jsx <a href="#t194.5 Rooms/index.jsx"> # </a></h3>
<p>src/pages/Rooms/index.jsx</p>
<pre><code class="lang-js">import React,{Component} from &apos;react&apos;;
export default class Rooms extends Component{
    render(){
        return (
            <div>Rooms</div>
        )    
    }
}
</code></pre>
<h3 id="t204.6 User/Login.jsx">4.6 User/Login.jsx <a href="#t204.6 User/Login.jsx"> # </a></h3>
<p>src/pages/User/Login.jsx</p>
<pre><code class="lang-js">import React,{Component} from &apos;react&apos;;
import {connect} from &apos;dva&apos;;
import Link from &apos;umi/link&apos;;
import {
    Form,
    Input,
    Button,
    Select,
    Row,
    Col,
    Popover,
    Progress,
    Tabs
} from &apos;antd&apos;;
import styles from &apos;./Login.less&apos;;
const FormItem=Form.Item;
const {Option}=Select;
const InputGroup=Input.Group;
const TabPane = Tabs.TabPane;

@connect(({register,loading}) =&gt; ({register,submitting: loading.effects[&apos;register/submit&apos;]}))
@Form.create()
export default class extends Component {
    state={
        count: 0,
        type:&apos;account&apos;
    };

    onGetCaptcha=() =&gt; {
        const {dispatch,form}=this.props;
        let mobile=form.getFieldValue(&apos;mobile&apos;);
        dispatch({type: &apos;register/getCaptcha&apos;,payload: mobile});
        let count=59;
        this.setState({count});
        this.interval=setInterval(() =&gt; {
            count-=1;
            this.setState({count});
            if (count===0) {
                clearInterval(this.interval);
            }
        },1000);
    };
    handleSubmit=e =&gt; {
        e.preventDefault();
        const {form,dispatch}=this.props;
        const {type}=this.state;
        form.validateFields({
            force: true
        },(err,values) =&gt; {
            if (!err) {
                dispatch({
                    type: &apos;login/submit&apos;,
                    payload: {
                        ...values,
                        type
                    }
                });
            }
        });
    };
    onSwitch = type =&gt; {
        this.setState({
          type,
        });
    };
    render() {
        const {form,submitting}=this.props;
        const {getFieldDecorator}=form;
        const {count}=this.state;
        return (
            <div classname="{styles.register}">
                <h3>&#x7528;&#x6237;&#x6CE8;&#x518C;</h3>
                <form onsubmit="{this.handleSubmit}">
                    <tabs defaultactivekey="account" onchange="{this.onSwitch}">
                      <tabpane tab="&#x8D26;&#x53F7;&#x5BC6;&#x7801;&#x767B;&#x5F55;" key="account">
                        <formitem>
                            {getFieldDecorator(&apos;email&apos;,{
                                rules: [
                                    {
                                        required: true,
                                        message: &apos;&#x90AE;&#x7BB1;&#x5FC5;&#x987B;&#x8F93;&#x5165;&apos;
                                    },{
                                        type: &apos;email&apos;,
                                        message: &apos;&#x90AE;&#x7BB1;&#x683C;&#x5F0F;&#x4E0D;&#x5408;&#x6CD5;&apos;
                                    }
                                ]
                            })(<input size="large" placeholder="&#x90AE;&#x7BB1;">)}
                        </formitem>
                        <formitem>
                            {getFieldDecorator(&apos;password&apos;,{
                                rules: [
                                    {
                                        required: true,
                                        message: &apos;&#x8BF7;&#x8F93;&#x5165;&#x5BC6;&#x7801;&#xFF01;&apos;
                                    }
                                ]
                            })(<input size="large" type="password" placeholder="&#x5BC6;&#x7801;">)}
                        </formitem>
                    </tabpane>
...

</tabs></form></div></code></pre>
<h3 id="t214.7 User/Login.less">4.7 User/Login.less <a href="#t214.7 User/Login.less"> # </a></h3>
<p>src/pages/User/Login.less</p>
<pre><code class="lang-less">.register{
    width:450px;
    border:1px solid #CCC;
    border-radius: 10px;
    padding:20px;
    h3{
        text-align: center;
    }
    .getCaptcha{
        width:100%;
        display:block;
    }
    .toRegister{
        float:right;
    }
}
</code></pre>
<h3 id="t224.8 User/Register.jsx">4.8 User/Register.jsx <a href="#t224.8 User/Register.jsx"> # </a></h3>
<p>src/pages/User/Register.jsx</p>
<pre><code class="lang-jsx">import React,{Component} from &apos;react&apos;;
import {connect} from &apos;dva&apos;;
import Link from &apos;umi/link&apos;;
import {
    Form,
    Input,
    Button,
    Select,
    Row,
    Col,
    Popover,
    Progress
} from &apos;antd&apos;;
import styles from &apos;./Register.less&apos;;
const FormItem=Form.Item;
const {Option}=Select;
const InputGroup=Input.Group;

const passwordStatusMap={
    ok: (
        <div classname="{styles.success}">
            &#x5F3A;&#x5EA6;: &#x5F3A;
                </div>
    ),
    pass: (
        <div classname="{styles.warning}">
            v&#x5F3A;&#x5EA6;: &#x4E2D;
                </div>
    ),
    poor: (
        <div classname="{styles.error}">
            &#x5F3A;&#x5EA6;: &#x592A;&#x77ED;
                </div>
    )
};
const passwordProgressMap={
    ok: &apos;success&apos;,
    pass: &apos;normal&apos;,
    poor: &apos;exception&apos;
};

@connect(({register,loading}) =&gt; ({register,submitting: loading.effects[&apos;register/submit&apos;]}))
@Form.create()
export default class extends Component {
    state={
        count: 0,
        confirmDirty: false,
        visible: false,
        help: &apos;&apos;,
        prefix: &apos;86&apos;
    };
    getPasswordStatus=() =&gt; {
        const {form}=this.props;
        const value=form.getFieldValue(&apos;password&apos;);
        if (value&amp;&amp;value.length&gt;9) {
            return &apos;ok&apos;;
        }
        if (value&amp;&amp;value.length&gt;5) {
            return &apos;pass&apos;;
        }
        return &apos;poor&apos;;
    };

    renderPasswordProgress=() =&gt; {
        const {form}=this.props;
        const value=form.getFieldValue(&apos;password&apos;);
        const passwordStatus=this.getPasswordStatus();
        return value&amp;&amp;value.length
            ? (
                <div classname="{styles[`progress-${passwordStatus}`]}">
                    <progress status="{passwordProgressMap[passwordStatus]}" classname="{styles.progress}" strokewidth="{6}" percent="{value.length*10">100
                            ? 100
                            :value.length*10}
                        showInfo={false} /&gt;
                </progress></div>
            )
            :null;
    };

    checkPassword=(rule,value,callback) =&gt; {
        const {visible,confirmDirty}=this.state;
        if (!value) {
            this.setState({
                help: &quot;&#x8BF7;&#x8F93;&#x5165;&#x5BC6;&#x7801;!&quot;,
                visible: !!value
            });
            callback(&apos;error&apos;);
        } else {
            this.setState({help: &apos;&apos;});
            if (!visible) {
                this.setState({
                    visible: !!value
                });
            }
            if (value.length&lt;6) {
                callback(&apos;error&apos;);
            } else {
                const {form}=this.props;
                if (value&amp;&amp;confirmDirty) {
                    form.validateFields([&apos;confirm&apos;],{force: true});
                }
                callback();
            }
        }
    };
    checkConfirm=(rule,value,callback) =&gt; {
        const {form}=this.props;
        if (value&amp;&amp;value!==form.getFieldValue(&apos;password&apos;)) {
            callback(&apos;&#x4E24;&#x6B21;&#x8F93;&#x5165;&#x7684;&#x5BC6;&#x7801;&#x4E0D;&#x5339;&#x914D;!&apos;);
        } else {
            callback();
        }
    };
    changePrefix=value =&gt; {
        this.setState({prefix: value});
    };
    onGetCaptcha=() =&gt; {
        const {dispatch,form}=this.props;
        let mobile=form.getFieldValue(&apos;mobile&apos;);
        dispatch({type: &apos;register/getCaptcha&apos;,payload: mobile});
        let count=59;
        this.setState({count});
        this.interval=setInterval(() =&gt; {
            count-=1;
            this.setState({count});
            if (count===0) {
                clearInterval(this.interval);
            }
        },1000);
    };
    handleSubmit=e =&gt; {
        e.preventDefault();
        const {form,dispatch}=this.props;
        form.validateFields({
            force: true
        },(err,values) =&gt; {
            console.log(&apos;values&apos;,values);
            if (!err) {
                const {prefix}=this.state;
                dispatch({
                    type: &apos;register/submit&apos;,
                    payload: {
                        ...values,
                        prefix
                    }
                });
            }
        });
    };
    render() {
        const {form,submitting}=this.props;
        const {getFieldDecorator}=form;
        const {count,prefix,help,visible}=this.state;
        return (
            <div classname="{styles.register}">
                <h3>&#x7528;&#x6237;&#x6CE8;&#x518C;</h3>
                <form onsubmit="{this.handleSubmit}">
                    <formitem>
                        {getFieldDecorator(&apos;email&apos;,{
                            rules: [
                                {
                                    required: true,
                                    message: &apos;&#x90AE;&#x7BB1;&#x5FC5;&#x987B;&#x8F93;&#x5165;&apos;
                                },{
                                    type: &apos;email&apos;,
                                    message: &apos;&#x90AE;&#x7BB1;&#x683C;&#x5F0F;&#x4E0D;&#x5408;&#x6CD5;&apos;
                                }
                            ]
                        })(<input size="large" placeholder="&#x90AE;&#x7BB1;">)}
                    </formitem>
                    <formitem help="{help}">
                        <popover content="{" <div="" style="{{padding:" '4px="" 0'}}="">
                                    {passwordStatusMap[this.getPasswordStatus()]}
                                    {this.renderPasswordProgress()}
                                    <div style="{{marginTop:" 10}}="">
                                      &#x8BF7;&#x81F3;&#x5C11;&#x8F93;&#x5165; 6 &#x4E2A;&#x5B57;&#x7B26;&#x3002;&#x8BF7;&#x4E0D;&#x8981;&#x4F7F;&#x7528;&#x5BB9;&#x6613;&#x88AB;&#x731C;&#x5230;&#x7684;&#x5BC6;&#x7801;&#x3002;
                                    </div>
                                </popover></formitem></form></div>
                            }
                            overlayStyle={{width: 240}}
                            placement=&quot;right&quot;
                            visible={visible}
                        &gt;
                            {getFieldDecorator(&apos;password&apos;,{
                                rules: [
                                    {
                                        validator: this.checkPassword
                                    }
                                ]
                            })(<input size="large" type="password" placeholder="&#x81F3;&#x5C11;&#x516D;&#x4F4D;&#x5BC6;&#x7801;&#xFF0C;&#x533A;&#x5206;&#x5927;&#x5C0F;&#x5199;">)}
                        
                    
                    <formitem>
                        {getFieldDecorator(&apos;confirm&apos;,{
                            rules: [
                                {
                                    required: true,
                                    message: &apos;&#x8BF7;&#x8F93;&#x5165;&#x786E;&#x8BA4;&#x5BC6;&#x7801;&#xFF01;&apos;
                                },{
                                    validator: this.checkConfirm
                                }
                            ]
                        })(<input size="large" type="password" placeholder="&#x786E;&#x8BA4;&#x5BC6;&#x7801;">)}
                    </formitem>
                    <formitem>
                        <inputgroup compact="">
                            <select size="large" value="{prefix}" onchange="{this.changePrefix}" style="{{" width:="" '20%'="" }}="">
                                <option value="86">+86</option>
                                <option value="87">+87</option>
                            </select>
                            {getFieldDecorator(&apos;mobile&apos;,{
                                rules: [
                                    {
                                        required: true,
                                        message: &apos;&#x8BF7;&#x8F93;&#x5165;&#x624B;&#x673A;&#x53F7;!&apos;
                                    },{
                                        pattern: /^\d{11}$/,
                                        message: &apos;&#x624B;&#x673A;&#x53F7;&#x683C;&#x5F0F;&#x9519;&#x8BEF;&#xFF01;&apos;
                                    }
                                ]
                            })(<input size="large" style="{{" width:="" '80%'="" }}="" placeholder="&#x624B;&#x673A;&#x53F7;">)}
                        </inputgroup>
                    </formitem>
                    <formitem>
                        <row gutter="{8}">
                            
                                {getFieldDecorator(&apos;captcha&apos;,{
                                    rules: [
                                        {
                                            required: true,
                                            message: &apos;&#x8BF7;&#x8F93;&#x5165;&#x9A8C;&#x8BC1;&#x7801;&#xFF01;&apos;
                                        }
                                    ]
                                })(<input size="large" placeholder="&#x9A8C;&#x8BC1;&#x7801;">)}
                            
                            
                                <button size="large" disabled="{count}" classname="{styles.getCaptcha}" onclick="{this.onGetCaptcha}">
                                    {count
                                        ? `${count} s`
                                        :&apos;&#x83B7;&#x53D6;&#x9A8C;&#x8BC1;&#x7801;&apos;}
                                </button>
                            
                        </row>
                    </formitem>
                    <formitem>
                        <button size="large" loading="{submitting}" classname="{styles.submit}" type="primary" htmltype="submit">
                            &#x6CE8;&#x518C;
                                                </button>
                        <link classname="{styles.login}" to="/User/Login">
                            &#x4F7F;&#x7528;&#x5DF2;&#x6709;&#x8D26;&#x6237;&#x767B;&#x5F55;
                                                
                    </formitem>
                
            

        );
    }
}
</code></pre>
<h3 id="t234.9 models/login.js">4.9 models/login.js <a href="#t234.9 models/login.js"> # </a></h3>
<p>src/pages/User/models/login.js</p>
<pre><code class="lang-js">import * as loginService from &apos;../services/login&apos;;
import router from &apos;umi/router&apos;;
export default {
  namespace: &apos;login&apos;,

  state: {

  },

  effects: {
      *getCaptcha({payload},{call,put}) {
         yield call(loginService.getCaptcha,payload);
    },
    *submit({payload},{call,put}) {
      let {code}=yield call(loginService.submit,payload);
      if(code == 0)
        router.push(&apos;/Rooms&apos;);
    }
  },

  reducers: {

  },
};

</code></pre>
<h3 id="t244.10 models/register.js">4.10 models/register.js <a href="#t244.10 models/register.js"> # </a></h3>
<p>src/pages/User/models/register.js</p>
<pre><code class="lang-js">import * as registerService from &apos;../services/register&apos;;
import router from &apos;umi/router&apos;;
export default {
  namespace: &apos;register&apos;,

  state: {

  },

  effects: {
      *getCaptcha({payload},{call,put}) {
         yield call(registerService.getCaptcha,payload);
    },
    *submit({payload},{call,put}) {
      yield call(registerService.submit,payload);
      router.push(&apos;/User/Login&apos;);
    }
  },

  reducers: {

  },
};

</code></pre>
<h3 id="t254.11 services/login.js">4.11 services/login.js <a href="#t254.11 services/login.js"> # </a></h3>
<p>src/pages/User/services/login.js</p>
<pre><code class="lang-js">import request from &apos;../../../utils/request&apos;;

export function getCaptcha(mobile) {
  return request(`/user/getCaptcha?mobile=${mobile}`);
}

export function submit(values) {
  return request(`/user/login`,{
    method: &apos;POST&apos;,
    body: JSON.stringify(values),
    headers: {
      &apos;Content-Type&apos;: &quot;application/json&quot;,
      &quot;Accept&quot;:&quot;application/json&apos;&quot;
    }
  });
}

</code></pre>
<h3 id="t264.12 services/register.js">4.12 services/register.js <a href="#t264.12 services/register.js"> # </a></h3>
<p>src/pages/User/services/register.js</p>
<pre><code class="lang-js">export function submit(values) {
  return request(`/user/register`,{
    method: &apos;POST&apos;,
    body: JSON.stringify(values),
    headers: {
      &apos;Content-Type&apos;: &quot;application/json&quot;,
      &quot;Accept&quot;:&quot;application/json&apos;&quot;
    }
  });
}
</code></pre>
<h3 id="t274.13 utils/request.js">4.13 utils/request.js <a href="#t274.13 utils/request.js"> # </a></h3>
<p>src/utils/request.js</p>
<pre><code class="lang-diff">-  return fetch(HOST+url, options)
+  return fetch(HOST+url,{
+    ...options,
+    credentials:&apos;include&apos;
+  })
</code></pre>
<h2 id="t285. &#x5B9E;&#x73B0;&#x623F;&#x95F4;&#x529F;&#x80FD;">5. &#x5B9E;&#x73B0;&#x623F;&#x95F4;&#x529F;&#x80FD; <a href="#t285. &#x5B9E;&#x73B0;&#x623F;&#x95F4;&#x529F;&#x80FD;"> # </a></h2>
<h3 id="t295.1 server/app.js">5.1 server/app.js <a href="#t295.1 server/app.js"> # </a></h3>
<p>server/app.js</p>
<pre><code class="lang-diff">+ let room=require(&apos;./routes/room&apos;);
app.use(&apos;/user&apos;,user);
+ app.use(&apos;/room&apos;,room);
</code></pre>
<h3 id="t305.2 models/index.js">5.2 models/index.js <a href="#t305.2 models/index.js"> # </a></h3>
<p>server/models/index.js</p>
<pre><code class="lang-diff">+
+const Room = conn.model(&apos;Room&apos;, {
+    name: {type: String,required: true}
+});
+
 module.exports={
-    User
+    User,
+    Room
 }
</code></pre>
<h3 id="t315.3 routes/room.js">5.3 routes/room.js <a href="#t315.3 routes/room.js"> # </a></h3>
<p>server/routes/room.js</p>
<pre><code class="lang-js">let express=require(&apos;express&apos;);
let router=express.Router();
const {Room}=require(&apos;../models&apos;);

router.get(&apos;/list&apos;,async function (req,res) {
    let list = await Room.find();
    res.json({
        code: 0,
        data:list
    });
});

router.post(&apos;/create&apos;,async function (req,res) {
    let {name}=req.body;
    await Room.create({name});
    res.json({
        code: 0,
        data:&apos;&#x623F;&#x95F4;&#x521B;&#x5EFA;&#x6210;&#x529F;&apos;
    });
});

module.exports=router;
</code></pre>
<h3 id="t325.4 Room/index.jsx">5.4 Room/index.jsx <a href="#t325.4 Room/index.jsx"> # </a></h3>
<p>src/pages/Room/index.jsx</p>
<pre><code class="lang-js">import React,{Component} from &apos;react&apos;;
import Link from &apos;umi/link&apos;;
import {connect} from &apos;dva&apos;;
import {Layout,Menu,Card,Input,Row,Col,Button,Form} from &apos;antd&apos;;
import styles from &apos;./index.less&apos;;
const {Header,Footer,Content}=Layout;

@connect(({room,loading}) =&gt; ({room,loading: loading.effects[&apos;room/list&apos;]}))
@Form.create()
export default class Rooms extends Component {
    createRoom=() =&gt; {
        let name=this.props.form.getFieldValue(&apos;keyword&apos;);
        if (name) {
            this.props.dispatch({
                type: &apos;room/create&apos;,
                payload:{name}
            });
        }
    }
    render() {
        let name=this.props.form.getFieldValue(&apos;keyword&apos;);
        let rooms=this.props.room.list;
        if (name) {
            rooms = rooms.filter(item =&gt; item.name.indexOf(name)!=-1);
        }

        return (
            <layout>
                <header>
                    <a classname="{styles.logo}">&#x73E0;&#x5CF0;&#x804A;&#x5929;&#x5BA4;</a>
                    <menu theme="dark" mode="horizontal" defaultselectedkeys="{[&apos;register&apos;]}" style="{{" lineheight:="" '64px'="" }}="">
                        <menu.item key="register">&#x6CE8;&#x518C;</menu.item>
                        <menu.item key="login">&#x767B;&#x5F55;</menu.item>
                    </menu>
                </header>
                <content>
                    <card>
                        <row gutter="{16}">
                            
                                {
                                    this.props.form.getFieldDecorator(&apos;keyword&apos;)(
                                        <input type="text" placeholder="&#x8BF7;&#x8F93;&#x5165;&#x623F;&#x95F4;&#x540D;">
                                    )
                                }
                            
                        </row>                
                    </card>
                    <card>
                        <row gutter="{16}">
                            {
                                rooms.length&gt;0?rooms.map(item =&gt; (
                                    
                                        <card title="{item.name}" extra="{&lt;Link" to="{`/Rooms/${item._id}`}">&#x8FDB;&#x5165;}
                                        &gt;
                                            <p>&#x7528;&#x6237;1</p>
                                            <p>&#x7528;&#x6237;2</p>
                                            <p>&#x7528;&#x6237;3</p>
                                        </card>
                                        
                                )):<button onclick="{this.createRoom}">&#x521B;&#x5EFA;&#x623F;&#x95F4;</button>
                            }
                        </row>
                    </card>
                </content>
                <footer>
                    <div classname="{styles.copyright}"> &#xA9;2018 &#x73E0;&#x5CF0;&#x57F9;&#x8BAD;</div>
                </footer>
            </layout>
        )
    }
}
</code></pre>
<h3 id="t335.5 Room/index.less">5.5 Room/index.less <a href="#t335.5 Room/index.less"> # </a></h3>
<p>src/pages/Room/index.less</p>
<pre><code class="lang-less">.logo{
    width:120px;
    height:64px;
    line-height: 64px;
    float:left;
}

.copyright{
    text-align:center;
}

</code></pre>
<h3 id="t345.6 models/room.js">5.6 models/room.js <a href="#t345.6 models/room.js"> # </a></h3>
<p>src/pages/Room/models/room.js</p>
<pre><code class="lang-js">import * as roomService from &apos;../services/room&apos;;
export default {

  namespace: &apos;room&apos;,

  state: {
    list: []
  },

  subscriptions: {
    setup({ dispatch, history }) {
      history.listen(({pathname,query}) =&gt; {
        if(pathname == &apos;/Room&apos;){
          dispatch({
            type:&apos;getRooms&apos;
          });
        }
      });
    },
  },

  effects: {
    *getRooms({ payload }, { call, put }) {
      let {data: list}=yield call(roomService.getRooms);
      yield put({type: &apos;save&apos;,payload: {list}});
    },
    *create({ payload }, { call, put }) {
      yield call(roomService.create,payload);
      yield put({type: &apos;getRooms&apos;});
    }
  },

  reducers: {
    save(state, action) {
      return { ...state, ...action.payload };
    },
  },
};
</code></pre>
<h3 id="t355.7 services/room.js">5.7 services/room.js <a href="#t355.7 services/room.js"> # </a></h3>
<p>src/pages/Room/services/room.js</p>
<pre><code class="lang-js">import request from &apos;../../../utils/request&apos;;

export function getRooms() {
  return request(`/room/list`);
}
export function create(values) {
  return request(`/room/create`,{
    method: &apos;POST&apos;,
    body: JSON.stringify(values),
    headers: {
      &apos;Content-Type&apos;: &quot;application/json&quot;,
      &quot;Accept&quot;:&quot;application/json&apos;&quot;
    }
  });
}
</code></pre>
<h2 id="t366. &#x5B9E;&#x73B0;&#x804A;&#x5929;&#x529F;&#x80FD;">6. &#x5B9E;&#x73B0;&#x804A;&#x5929;&#x529F;&#x80FD; <a href="#t366. &#x5B9E;&#x73B0;&#x804A;&#x5929;&#x529F;&#x80FD;"> # </a></h2>
<h3 id="t376.1 server/app.js">6.1 server/app.js <a href="#t376.1 server/app.js"> # </a></h3>
<p>server/app.js</p>
<pre><code class="lang-js">let express=require(&apos;express&apos;);
let session=require(&apos;express-session&apos;);
const cors=require(&apos;cors&apos;);
const bodyParser=require(&apos;body-parser&apos;);
const {User,Room,Message}=require(&apos;./models&apos;);
let app=express();
app.use(cors({
    origin:&apos;http://localhost:8000&apos;,
    credentials:true
}));
app.use(bodyParser.json());
app.use(session({
    resave:true,
    secret:&apos;zfpx&apos;,
    saveUninitialized:true
}));
let user=require(&apos;./routes/user&apos;);
let room=require(&apos;./routes/room&apos;);
app.use(&apos;/user&apos;,user);
app.use(&apos;/room&apos;,room);
let server=require(&apos;http&apos;).createServer(app);
server.listen(3000);
let io=require(&apos;socket.io&apos;)(server);
io.on(&apos;connection&apos;,async function (socket) {
    let userId=socket.handshake.query.user;//&#x7528;&#x6237;
    let user=await User.findById(userId);
    let roomId=socket.handshake.query.room; //&#x623F;&#x95F4;
    //&#x67E5;&#x627E;&#x623F;&#x95F4;
    let room=await Room.findById(roomId);
    socket.join(roomId);//&#x628A;&#x5F53;&#x524D;socket&#x6DFB;&#x52A0;&#x5230;&#x623F;&#x95F4;&#x91CC;
    //&#x628A;&#x7528;&#x6237;&#x653E;&#x5230;&#x623F;&#x95F4;&#x91CC;
    await User.findByIdAndUpdate(userId,{room: roomId});
    socket.on(&apos;getRoom&apos;,async function () {
        //&#x67E5;&#x627E;&#x623F;&#x95F4;&#x4E2D;&#x7684;&#x7528;&#x6237;
        let users=await User.find({room: roomId});
        //&#x67E5;&#x627E;&#x623F;&#x95F4;&#x91CC;&#x7684;&#x6D88;&#x606F;
        let messages = await Message.find({room: roomId}); 
        socket.emit(&apos;room&apos;,{room,users,messages});
    });
    socket.on(&apos;message&apos;,async function (content) {
        let {_id} = await Message.create({
            user:userId,
            content,
            room:roomId
        });
        let message=await Message.findById(_id).populate(&apos;user&apos;).populate(&apos;room&apos;).exec();
        io.in(roomId).emit(&apos;message&apos;,message);
    });

});
</code></pre>
<h3 id="t386.2 models/index.js">6.2 models/index.js <a href="#t386.2 models/index.js"> # </a></h3>
<p>server/models/index.js</p>
<pre><code class="lang-js">const mongoose = require(&apos;mongoose&apos;);
const Schema = mongoose.Schema;
const ObjectId = Schema.Types.ObjectId;
const {DB} = require(&apos;../config&apos;);
const conn = mongoose.createConnection(DB.url,{ useNewUrlParser: true });
const User = conn.model(&apos;User&apos;, {
    email: {type: String,required: true},        //&#x90AE;&#x7BB1; 
    password: {type: String,required: true},     //&#x5BC6;&#x7801;
    mobile: {type: String,required: true},       //&#x624B;&#x673A;&#x53F7;
    avatar: {type: String,required: false},      //&#x5934;&#x50CF;
    createAt: {type: Date,default: Date.now},    //&#x521B;&#x5EFA;&#x65F6;&#x95F4; 
    room:{type:ObjectId,ref:&apos;Room&apos;}              //&#x6240;&#x5C5E;&#x623F;&#x95F4;
});

const Room = conn.model(&apos;Room&apos;, {
    name: {type: String,required: true},         //&#x623F;&#x95F4;&#x540D;
    avatar: {type: String},                      //&#x623F;&#x95F4;&#x56FE;&#x7247;
    createAt:{type:Date,default:Date.now}        //&#x521B;&#x5EFA;&#x65F6;&#x95F4;
});

const Message = conn.model(&apos;Message&apos;, {
    content: {type: String},                     //&#x5185;&#x5BB9;
    user: {type: ObjectId,ref: &apos;User&apos;},          //&#x7528;&#x6237;
    createAt: {type: Date,default: Date.now},    //&#x521B;&#x5EFA;&#x65F6;&#x95F4; 
    room:{type:ObjectId,ref:&apos;Room&apos;}              //&#x623F;&#x95F4;
});


module.exports={
    User,
    Room,
    Message
}
</code></pre>
<h3 id="t396.3 routes/user.js">6.3 routes/user.js <a href="#t396.3 routes/user.js"> # </a></h3>
<p>server/routes/user.js</p>
<pre><code class="lang-diff">+ const gravatar=require(&apos;gravatar&apos;);
-    let user=new User({email,password,mobile});
+    let user=new User({email,password,mobile,avatar});
-            res.json({code:0,data:&apos;&#x767B;&#x5F55;&#x6210;&#x529F;&apos;});
+            res.json({code:0,data:oldUser});
-            res.json({code:0,data:&apos;&#x767B;&#x5F55;&#x6210;&#x529F;&apos;});
+            res.json({code:0,data:oldUser});
</code></pre>
<h3 id="t406.4 Room/$id.jsx">6.4 Room/$id.jsx <a href="#t406.4 Room/$id.jsx"> # </a></h3>
<p>src/pages/Room/$id.jsx</p>
<pre><code class="lang-js">import React,{Component} from &apos;react&apos;;
import {connect} from &apos;dva&apos;;
import {Layout,Menu,Card,Input,Row,Col,Button,Form,List,Avatar} from &apos;antd&apos;;
const {Header,Sider,Footer,Content}=Layout;
@connect(({chat}) =&gt; ({chat}))
@Form.create()    
export default class Chat extends Component {
    talk=() =&gt; {
        let content=this.props.form.getFieldValue(&apos;content&apos;);
        this.props.dispatch({
            type: &apos;chat/talk&apos;,
            payload:content
        });
    }
    render() {
        let {users,messages}=this.props.chat;
        return (
            <layout>
                <header><a href="#">&#x73E0;&#x5CF0;&#x804A;&#x5929;&#x5BA4;</a></header>
                <layout>
                    <sider>
                        <menu theme="dark" mode="vertical" defaultselectedkeys="{[]}">
                            {
                                users.map(user =&gt; (<menu.item key="{user._id}">{user.email}</menu.item>))
                            }
                        </menu>
                    </sider>
                    <content style="{{height:" '600px'}}="">
                        <card>
                            <list itemlayout="horizontal" datasource="{messages}" renderitem="{item" ==""> (
                                <list.item>
                                    <list.item.meta avatar="{&lt;Avatar" src="{item.user.avatar}">}
                                        title={item.user.email}
                                        description={item.content}
                                    /&gt;
                                </list.item.meta></list.item>
                            )}
                         /&gt;
                        </list></card>
                        <card>
                            <row gutter="{8}">
                                
                                    {
                                        this.props.form.getFieldDecorator(&apos;content&apos;)(<input>)
                                    }
                                
                                <button onclick="{this.talk}">&#x53D1;&#x8A00;</button>
                            </row>
                        </card>
                    </content>
                </layout>
                <footer style="{{textAlign:&apos;center&apos;}}">
                        @2018 &#x73E0;&#x5CF0;&#x57F9;&#x8BAD;
                </footer>
            </layout>
        )
    }
}

</code></pre>
<h3 id="t416.5 Room/index.jsx">6.5 Room/index.jsx <a href="#t416.5 Room/index.jsx"> # </a></h3>
<p>src/pages/Room/index.jsx</p>
<pre><code class="lang-diff">-     extra={<link to="{`/Rooms/${item._id}`}">&#x8FDB;&#x5165;}
+     extra={<link to="{`/Room/${item._id}`}">&#x8FDB;&#x5165;}
</code></pre>
<h3 id="t426.6 models/chat.js">6.6 models/chat.js <a href="#t426.6 models/chat.js"> # </a></h3>
<p>src/pages/Room/models/chat.js</p>
<pre><code class="lang-js">import IO from &apos;socket.io-client&apos;;
import router from &apos;umi/router&apos;;
export default {
  namespace: &apos;chat&apos;,

  state: {
    room: {},
    users: [],
    messages:[]
  },

  subscriptions: {
    setup({ dispatch, history }) {
      history.listen(({pathname,query}) =&gt; {
        let regexp=/\/Room\/([^/]+)$/;
        let result=pathname.match(regexp);
        if (result) {
          let roomId=result[1];
          let userStr = window.sessionStorage.getItem(&apos;user&apos;);
          if (userStr) {
            let user=JSON.parse(userStr);
            const socket= window.socket = new IO(&apos;http://localhost:3000&apos;,{query:{user:user._id,room:roomId}});
            socket.on(&apos;room&apos;,function ({room,users,messages}) {
                dispatch({type: &apos;save&apos;,payload: {room,users,messages}});
            });
            socket.emit(&apos;getRoom&apos;);
            socket.on(&apos;message&apos;,function (message) {
              console.log(message);
              dispatch({type: &apos;messageAdded&apos;,payload:message});
            });
          } else {
            router.push(&apos;/User/Login&apos;);
          }
        } 
      });
    },
  },
  effects: {
    *talk({payload},{call,put,select}) {
      window.socket.emit(&apos;message&apos;,payload);
   }
  },
  reducers: {
    save(state, action) {
      return { ...state, ...action.payload };
    },
    messageAdded(state,{payload}) {
      return {...state, messages:[...state.messages,payload] };
    }
  }
};

</code></pre>
<h3 id="t436.7 models/room.js">6.7 models/room.js <a href="#t436.7 models/room.js"> # </a></h3>
<p>src/pages/Room/models/room.js</p>
<pre><code class="lang-js">-    dispatch({
-       type:&apos;getRooms&apos;
-    });
+    dispatch({type:&apos;getRooms&apos;});
</code></pre>
<h3 id="t446.8 models/login.js">6.8 models/login.js <a href="#t446.8 models/login.js"> # </a></h3>
<p>src/pages/User/models/login.js</p>
<pre><code class="lang-diff">-      let {code}=yield call(loginService.submit,payload);
-      if(code == 0)
-        router.push(&apos;/Rooms&apos;);
+      let {code,data}=yield call(loginService.submit,payload);
+      if (code==0) {
+        yield put({type: &apos;save&apos;,payload: {user: data}});
+        window.sessionStorage.setItem(&apos;user&apos;,JSON.stringify(data));
+        router.push(&apos;/Room&apos;);
+      }
</code></pre>
<h2 id="t457. &#x4E0A;&#x4F20;&#x56FE;&#x7247;">7. &#x4E0A;&#x4F20;&#x56FE;&#x7247; <a href="#t457. &#x4E0A;&#x4F20;&#x56FE;&#x7247;"> # </a></h2>
<h3 id="t467.1 server/app.js">7.1 server/app.js <a href="#t467.1 server/app.js"> # </a></h3>
<p>server/app.js</p>
<pre><code class="lang-diff">-app.use(bodyParser.json());
+app.use(bodyParser.json({limit:&apos;1000kb&apos;}));

-        let messages = await Message.find({room: roomId}); 
-        console.log(room,users,messages);
+        let messages = await Message.find({room: roomId}).populate(&apos;user&apos;); 
</code></pre>
<h3 id="t477.2 models/index.js">7.2 models/index.js <a href="#t477.2 models/index.js"> # </a></h3>
<p>server/models/index.js</p>
<pre><code class="lang-diff">-    createAt:{type:Date,default:Date.now}        //&#x521B;&#x5EFA;&#x65F6;&#x95F4;
+    createAt: {type: Date,default: Date.now},        //&#x521B;&#x5EFA;&#x65F6;&#x95F4;
+    users:[{type:ObjectId,ref:&apos;User&apos;}]
</code></pre>
<h3 id="t487.3 routes/room.js">7.3 routes/room.js <a href="#t487.3 routes/room.js"> # </a></h3>
<p>server/routes/room.js</p>
<pre><code class="lang-diff">-const {Room}=require(&apos;../models&apos;);
+const {Room,User}=require(&apos;../models&apos;);

-    let list = await Room.find();
+    let list=await Room.find();
+    for (let i=0;i</code></pre>
<h3 id="t497.4 routes/user.js">7.4 routes/user.js <a href="#t497.4 routes/user.js"> # </a></h3>
<p>server/routes/user.js</p>
<pre><code class="lang-diff">+ router.post(&apos;/changeAvatar&apos;,async function (req,res) {
+     let {userId,avatar}=req.body;
+     try {
+         let user = await User.findById(userId);
+         user.avatar=avatar;
+         await user.save();
+         res.json({code:0,data:user});
+     } catch (error) {
+         res.json({code:1,error});
+     }
+ });
</code></pre>
<h3 id="t507.5 Room/index.jsx">7.5 Room/index.jsx <a href="#t507.5 Room/index.jsx"> # </a></h3>
<p>src/pages/Room/index.jsx</p>
<pre><code class="lang-js">import React,{Component} from &apos;react&apos;;
import Link from &apos;umi/link&apos;;
import {connect} from &apos;dva&apos;;
import Cropper from &apos;react-cropper&apos;;
import &apos;cropperjs/dist/cropper.css&apos;; 
import {Layout,Menu,Card,Input,Row,Col,Button,Form,List,Avatar,Modal} from &apos;antd&apos;;
import styles from &apos;./index.less&apos;;
const {Header,Footer,Content}=Layout;

@connect(({room,login,loading}) =&gt; ({room,login}))
@Form.create()
export default class Rooms extends Component {
    state={
        src: &apos;&apos;,
        cropperVisible: false
    }
    createRoom=() =&gt; {
        let name=this.props.form.getFieldValue(&apos;keyword&apos;);
        if (name) {
            this.props.dispatch({
                type: &apos;room/create&apos;,
                payload:{name}
            });
        }
    }
    //&#x4E0A;&#x4F20;&#x56FE;&#x7247;
    changeAvatar=(userId) =&gt; {
        let that=this;
        const $input=document.createElement(&apos;input&apos;);
        $input.style.display = &apos;none&apos;;
        $input.setAttribute(&apos;type&apos;, &apos;file&apos;);
        $input.setAttribute(&apos;accept&apos;,&apos;*/*&apos;);
        $input.onchange=(e) =&gt; {
            const file=e.target.files[0];
            if (!file) return;
            const reader=new FileReader();
            reader.onloadend=function () {
                let avatar=this.result;
                that.setState({
                    src: avatar,
                    cropperVisible:true
                });

            }
            reader.readAsDataURL(file);
        }
        $input.click();
    }
    confirmChange=(userId) =&gt; {
        let avatar = this.cropper.getCroppedCanvas().toDataURL();
        this.setState({cropperVisible:false});
        this.props.dispatch({
               type: &apos;login/changeAvatar&apos;,
               payload: {userId,avatar}
        }); 
    }
    render() {
        let name=this.props.form.getFieldValue(&apos;keyword&apos;);
        let rooms=this.props.room.list;
        if (name) {
            rooms = rooms.filter(item =&gt; item.name.indexOf(name)!=-1);
        }

        return (
            <layout>
                <header>
                    <row>
                        <a classname="{styles.logo}">&#x73E0;&#x5CF0;&#x804A;&#x5929;&#x5BA4;</a>
                        <menu theme="dark" mode="horizontal" defaultselectedkeys="{[&apos;register&apos;]}" style="{{" lineheight:="" '64px'="" }}="">
                        <menu.item key="register">&#x6CE8;&#x518C;</menu.item>
                        <menu.item key="login">&#x767B;&#x5F55;</menu.item>
                        </menu>
                        {this.props.login.user&amp;&amp;<avatar onclick="{()=">this.changeAvatar(this.props.login.user._id)} src={this.props.login.user.avatar}/&gt;}
                    </avatar></row>
                </header>
                <content>
                    <card>
                        <row gutter="{16}">
                            
                                {
                                    this.props.form.getFieldDecorator(&apos;keyword&apos;)(
                                        <input type="text" placeholder="&#x8BF7;&#x8F93;&#x5165;&#x623F;&#x95F4;&#x540D;">
                                    )
                                }
                            
                        </row>                
                    </card>
                    <card>
                        <row gutter="{16}">
                            {
                                rooms.length&gt;0?rooms.map(item =&gt; (
                                    
                                        <card title="{item.name}" extra="{&lt;Link" to="{`/Room/${item._id}`}">&#x8FDB;&#x5165;}
                                        &gt;
                                            {
                                                item.users.map(user =&gt; <avatar style="{{marginLeft:5}}" src="{user.avatar}">)
                                            }
                                        </avatar></card>
                                        
                                )):<button onclick="{this.createRoom}">&#x521B;&#x5EFA;&#x623F;&#x95F4;</button>
                            }
                        </row>
                    </card>
                </content>
                <footer>
                    <div classname="{styles.copyright}"> &#xA9;2018 &#x73E0;&#x5CF0;&#x57F9;&#x8BAD;</div>
                </footer>
                <modal onok="{()=">this.confirmChange(this.props.login.user._id)}
                    onCancel={()=&gt;this.setState({cropperVisible:false})}
                    visible={this.state.cropperVisible} &gt;
                    <cropper ref="{i=">this.cropper =i}
                            src={this.state.src}
                            style={{height: 400, width: 400}}
                            aspectRatio={16 / 9}
                        guides={false} /&gt;
                </cropper></modal>
            </layout>
        )
    }
}
</code></pre>
<h3 id="t517.6 /models/chat.js">7.6 /models/chat.js <a href="#t517.6 /models/chat.js"> # </a></h3>
<p>src/pages/Room/models/chat.js</p>
<pre><code class="lang-js">+ dispatch({type: &apos;login/save&apos;,payload: {user}});
</code></pre>
<h3 id="t527.7 models/room.js">7.7 models/room.js <a href="#t527.7 models/room.js"> # </a></h3>
<p>src/pages/Room/models/room.js</p>
<pre><code class="lang-diff">-        if(pathname == &apos;/Room&apos;){
-          dispatch({type:&apos;getRooms&apos;});
+        if (pathname==&apos;/Room&apos;) {
+          let userStr = window.sessionStorage.getItem(&apos;user&apos;);
+          if (userStr) {
+            let user=JSON.parse(userStr);
+            dispatch({type: &apos;login/save&apos;,payload: {user}});
+            dispatch({type:&apos;getRooms&apos;});
+          } else {
+            router.push(&apos;/User/Login&apos;);
+          }
</code></pre>
<h3 id="t537.8 models/login.js">7.8 models/login.js <a href="#t537.8 models/login.js"> # </a></h3>
<p>src/pages/User/models/login.js</p>
<pre><code class="lang-diff">+    *changeAvatar({payload},{call,put}) {
+      let {code,data}=yield call(loginService.changeAvatar,payload);
+      if (code==0) {
+        window.sessionStorage.setItem(&apos;user&apos;,JSON.stringify(data));
+        yield put({type: &apos;save&apos;,payload: {user: data}});
+      }
</code></pre>
<h3 id="t547.9 services/login.js">7.9 services/login.js <a href="#t547.9 services/login.js"> # </a></h3>
<p>src/pages/User/services/login.js</p>
<pre><code class="lang-js">export function changeAvatar(values) {
  return request(`/user/changeAvatar`,{
    method: &apos;POST&apos;,
    body: JSON.stringify(values),
    headers: {
      &apos;Content-Type&apos;: &quot;application/json&quot;,
      &quot;Accept&quot;:&quot;application/json&apos;&quot;
    }
  });
}
</code></pre>
<h2 id="t55&#x53C2;&#x8003;&#x94FE;&#x63A5;">&#x53C2;&#x8003;&#x94FE;&#x63A5; <a href="#t55&#x53C2;&#x8003;&#x94FE;&#x63A5;"> # </a></h2>
<ul>
<li><a href="https://gitee.com/zhufengpeixun/zhufeng-dva-chat">zhufeng-dva-chat</a></li>
<li><a href="https://ant.design/docs/react/introduce-cn">ant.design</a></li>
<li><a href="https://pro.ant.design/index-cn">pro.ant.design</a></li>
<li><a href="https://umijs.org/zh/">umijs</a></li>
<li><a href="http://www.ucpaas.com">ucpaas</a></li>
</ul>

        <div class="copyright">Powered by <a href="https://github.com/jaywcjlove/idoc" target="_blank">idoc</a>. Dependence <a href="https://nodejs.org">Node.js</a> run.</div>
    